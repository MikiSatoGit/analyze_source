/****************************************************************************/
/* ファイル名	: func_fmcw.c												*/
/*--------------------------------------------------------------------------*/
/* モジュール名	: FMCW信号処理サブモジュール								*/
/*--------------------------------------------------------------------------*/
/* 機能			: 															*/
/*--------------------------------------------------------------------------*/
/* 備考			:															*/
/*--------------------------------------------------------------------------*/
/* 構成関数		: 															*/
/*--------------------------------------------------------------------------*/
/* 変更履歴		:															*/
/* Version				date				name							*/
/*	t01					14.02.17			走安技1 1技室 Y.Yamada			*/
/*	新規作成																*/
/*	t02					14.02.21			走安技1 1技室 Y.Yamada			*/
/*	trigonoの三角関数をasm版からC版へ変更									*/
/*	t03					14.02.24			走安技1 1技室 Y.Yamada			*/
/*	認識の動作モード切替えコンフィグを追加									*/
/*	t04					14.05.06			走安技1 1技室 Y.Yamada			*/
/*	BSM認識処理のSTEP2対応													*/
/*	t05					14.06.11			走安技1 1技室 Y.Hosoi			*/
/*	MUSICスペクトラム作成修正												*/
/*	t06					14.08.05			走安技1 1技室 Y.Yamada			*/
/*	検出結果出力モード（検査ID  49）方位展開の範囲を修正	 				*/
/*	t07					14.08.06			走安技1 1技室 Y.Yamada			*/
/*	検出結果出力モード（検査ID  49）到来波推定飛びを修正	 				*/
/*	t08					14.10.28			走安技1 1技室 K.Kato			*/
/*  t300 リファクタリング 及び、9/17版 BSM最新仕様マージ					*/
/*	t09					14.10.28			走安技1 1技室 K.Kato			*/
/*  コンパイルスイッチで無効化していた台形ピークサーチ関数を削除			*/
/*	t10					14.11.07			走安技1 1技室 K.Kato			*/
/*  残課題 No.155対応														*/
/*	t11					14.11.10			走安技1 1技室 K.Kato			*/
/*  残課題 No.157対応														*/
/*	t12					15.02.26			走安技2 1技室 G.Jomori			*/
/*	BSM AS巻替対応															*/
/*	t13					15.02.26			走安技2 1技室 G.Jomori			*/
/*	BSM AS巻替 仕様確認項目対応												*/
/*	t14					15.02.26			走安技2 1技室 G.Jomori			*/
/*	BSM AS巻替 int→S4,float→FLに変更										*/
/*	t15					15.02.27			走安技2 1技室 G.Jomori			*/
/*	BSM AS巻替 インデント修正 //コメント変更(OBJ変更なし)					*/
/*	t17					15.03.04			走安技2 1技室 H.Nonogaki		*/
/*	軸調整・軸検査開発ラインを本流にマージ									*/
/*	t18					15.03.23			走安技2 1技室 G.Jomori			*/
/*	仕様確認No986対応														*/
/*	t19					15.03.23			走安技2 1技室 G.Jomori			*/
/*	BSM一致確認で発見したバグ修正											*/
/*	t20					15.05.18			走安技2 1技室 G.Jomori			*/
/*	MWR-TEST-24G-20（FS向け）対応											*/
/*	t21					15.05.26			走安技2 1技室 G.Jomori			*/
/*	残課題No492対応															*/
/*	t23					15.08.06			走安技2 1技室 G.Jomori			*/
/*	BSM 認識巻替対応(DR実施分)												*/
/*	t24					15.08.06			走安技2 1技室 G.Jomori			*/
/*	BSM 認識巻替対応(コードクロスで良い分)									*/
/*	t25					15.08.07			走安技2 1技室 G.Jomori			*/
/*	BSM 認識巻替対応 一致確認中に発見したバグ修正							*/
/*	t26					15.08.31			走安技2 1技室 G.Jomori			*/
/*	仕様確認No1505,1506対応													*/
/*	t27					15.09.01			走安技2 1技室 G.Jomori			*/
/*	SIM_MODEのときのfn_qr_cal_4chを認識SIMのqr_cal_pivotに置き換える(OBJ変更なし)*/
/*	t28					15.09.11			走安技2 1技室 G.Jomori			*/
/*	残課題No583対応															*/
/*	t29					15.10.08			走安技2 1技室 H.Nonogaki		*/
/*	残課題No834(横展開漏れ防止)対応											*/
/*	t30					15.10.23			走安技2 1技室 M.Tanaka			*/
/*	残課題No.849対応(暗黙のキャストを修正)									*/
/*	t31					15.11.27			走安技2 1技室 G.Jomori			*/
/*	残課題No872(CodeSonar指摘)対応											*/
/*	t32					15.11.27			走安技2 1技室 G.Jomori			*/
/*	BSM CV(第2弾)対応														*/
/*	t33					15.11.27			走安技2 1技室 G.Jomori			*/
/*	BSM CV(第2弾)対応 変更関数リファクタリング(OBJ変更なし)					*/
/*	t34					15.11.27			走安技2 1技室 G.Jomori			*/
/*	仕様確認No2122対応 														*/
/*	t38					16.02.04			走安技2 1技室 Y.Yamada			*/
/*	CV向け認識Grソフト変更 t204b反映										*/
/*	t39					16.02.24			走安技2 1技室 G.Jomori			*/
/*	291B 開発ラインのt248マージ												*/
/*	t40					16.03.03			走安技2 1技室 G.Jomori			*/
/*	残課題No1198対応(ローカル配列変数の宣言と同時に実施の初期化分離)		*/
/*	t41					16.03.03			走安技2 1技室 G.Jomori			*/
/*	残課題No1099対応(intをS4に変更)(OBJ変更なし)							*/
/*	t42					16.03.07			走安技2 1技室 G.Jomori			*/
/*	仕様確認No1600対応(0割ガード処理を回答に合わせて変更)					*/
/*	t43					16.03.25			走安技2 1技室 G.Jomori			*/
/*	291B BSM CV仕様対応														*/
/*	t44					16.03.29			走安技2 1技室 G.Jomori			*/
/*	291B BSM CV仕様 読み合わせ指摘事項対応(OBJ変更なし)						*/
/*	t45					16.04.07			走安技2 1技室 G.Jomori			*/
/*	BSM 残課題No1255対応													*/
/*	t46					16.04.11			走安技2 1技室 H.Nonogaki		*/
/*	残課題No.1096対応(OBJ変更無し)											*/
/*	t47					16.04.12			走安技2 1技室 G.Jomori			*/
/*	QAC 指摘対応(OBJ変更なし)												*/
/*	t48					16.04.15			走安技2 1技室 G.Jomori			*/
/*	残課題No.1278対応(OBJ変更無し)											*/
/*	t49					16.04.22			走安技2 1技室 Y.Yamada			*/
/*	fn_cmn_qr_cal_4chをECUとSIMで共通化										*/
/*	t50					16.05.18			走安技2 1技室 Y.Nishioka		*/
/*	読み替えテーブルの線形補間を全ての結果に対して適用						*/
/*	t51					16.05.18			走安技2 1技室 Y.Nishioka		*/
/*	mwr_24G_0024_t614をマージ												*/
/*	t52					16.06.20			走安技2 1技室 G.Jomori			*/
/*	BSM QAC指摘事項修正 OBJ変更なし											*/
/*	t53					16.06.20			走安技2 1技室 G.Jomori			*/
/*	BSM 残課題No1336対応 OBJ変更なし										*/
/*	t54					16.06.21			走安技2 1技室 G.Jomori			*/
/*	BSM QAC指摘事項修正 OBJ変更なし											*/
/*	t55					16.06.22			走安技2 1技室 G.Jomori			*/
/*	BSM QAC指摘事項修正 OBJ変更なし											*/
/*	t56					16.06.24			走安技2 1技室 Y.Yamada			*/
/*	BSM 嵩上げ横展変更 OBJ変更なし											*/
/*	t58					16.06.29			走安技2 1技室 Y.Yamamoto		*/
/*	SIM用コード修正															*/
/*	p00					16.07.06			走安技2 1技室 Y.Nishioka		*/
/*	010B 1A納入のためP化を実施												*/
/*	t61					16.08.10			走安技2 1技室 G.Jomori			*/
/*	残課題No1403対応(到来波数1固定処理有効化)								*/
/*	t64					16.08.24			走安技2 1技室 G.Jomori			*/
/*	010B 2A 認識部分(BSM,RCTA,AUDR)マージ									*/
/****************************************************************************/

#include "../inc_bsm.h"
#include "../parameter_def.h"

#include "../bsm_main.h"
#include "filter_cal_512.h"	/* $$$ 2013.08.22-1 */
#include "filter_cal_fsk.h"	/* $$$ 2013.08.22-1 */

#include "func_fmcw.h"
#include "../../../common/inc_mwr.h"

/**************************************************************************************************/
/* ↓↓↓↓↓↓↓      シミュレーター用コード ECU時はコンパイル対象外             ↓↓↓↓↓↓↓  */
/**************************************************************************************************/
#if (MODE_ECU_SIM == SIM_MODE)
/* LINPACK include files  */
#include "dsp_rt.h"
#include "simstruc_types.h"
#include "dspqrdc_rt.h"
#include "tmwtypes.h"
/* #include "dsp_iso_math_rt.h" */


VD fn_matrix_spec_4ch(
	FL afl_a_E[4][4],				/*  [in] */
	FL afl_a_spec[N_DOA],			/*  [out] */
	S4 s4_a_wave_num,				/*  [in] */
	S4 s4_a_updn_flg,				/*  [in] */
/* 	FL fl_a_installed_angle			_20140108_1 */
	S4 s4_a_start_bin,				/* _20140113_4 */
	S4 s4_a_end_bin				/* _20140113_4 */
);

VD fn_matrix_spec_4ch_all(
	FL afl_a_E[4][4],						/*  [in] */
	FL afl_a_spec[N_DOA],					/*  [out] */
	S4 s4_a_wave_num,						/*  [in] */
	S4 s4_a_updn_flg						/*  [in] */
);

VD fn_qr_cal_pivot(
	FL afl_a_R_0[4][4],		/*  [in] */
	FL afl_a_Lam[4],		/*  [out] */
	FL afl_a_B[4][4]		/*  [out] */
);
#endif
/**************************************************************************************************/
/* ↑↑↑↑↑↑↑      シミュレーター用コード ECU時はコンパイル対象外             ↑↑↑↑↑↑↑  */
/**************************************************************************************************/

VD fn_matmul_4x4(
	FL afl_a_mat_A[4][4],
	FL afl_a_mat_B[4][4],
	FL afl_a_mat_C[4][4]
);


volatile const FL CAFL_D_MODE_VECTOR_0[180] = {
	-0.968095799663108F,
	-0.968717147780959F,
	-0.970578889742614F,
	-0.973674108130768F,
	-0.977991239938984F,
	-0.983514026169386F,
	-0.990221442397787F,
	-0.998087611435014F,
	-1.007081699535990F,
	-1.017167797930620F,
	-1.028304791772340F,
	-1.040446218919910F,
	-1.053540121285410F,
	-1.067528891793620F,
	-1.082349120303800F,
	-1.097931442142050F,
	-1.114200393176780F,
	-1.131074275639590F,
	-1.148465039143720F,
	-1.166278181578710F,
	-1.184412674758120F,
	-1.202760919861110F,
	-1.221208737834640F,
	-1.239635400002900F,
	-1.257913704160480F,
	-1.275910101398160F,
	-1.293484878819880F,
	-1.310492403149960F,
	-1.326781429995460F,
	-1.342195483214830F,
	-1.356573308445240F,
	-1.369749404354510F,
	-1.381554634604800F,
	-1.391816922844190F,
	-1.400362032276770F,
	-1.407014430503790F,
	-1.411598239379780F,
	-1.413938268593140F,
	-1.413861130565440F,
	-1.411196433077990F,
	-1.405778044785130F,
	-1.397445427476920F,
	-1.386045027620770F,
	-1.371431718360720F,
	-1.353470281801300F,
	-1.332036920071530F,
	-1.307020782374310F,
	-1.278325494001240F,
	-1.245870672155600F,
	-1.209593412403220F,
	-1.169449728685210F,
	-1.125415929104450F,
	-1.077489909162510F,
	-1.025692343797820F,
	-0.970067759481250F,
	-0.910685467779908F,
	-0.847640342219378F,
	-0.781053420972107F,
	-0.711072318882710F,
	-0.637871433614129F,
	-0.561651932261103F,
	-0.482641506623339F,
	-0.401093887449023F,
	-0.317288110333313F,
	-0.231527528563885F,
	-0.144138571019063F,
	-0.055469246210602F,
	0.034112603314752F,
	0.124221288785524F,
	0.214455494535438F,
	0.304400714899947F,
	0.393631891518568F,
	0.481716230780643F,
	0.568216178210032F,
	0.652692523854560F,
	0.734707610279765F,
	0.813828612612482F,
	0.889630858282442F,
	0.961701152709717F,
	1.029641076216490F,
	1.093070216931180F,
	1.151629304421560F,
	1.204983209253790F,
	1.252823774629970F,
	1.294872447703660F,
	1.330882680096550F,
	1.360642069519170F,
	1.383974217202050F,
	1.400740279033880F,
	1.410840191833500F,
	1.414213560000000F,
	1.410840191833500F,
	1.400740279033880F,
	1.383974217202050F,
	1.360642069519170F,
	1.330882680096550F,
	1.294872447703660F,
	1.252823774629970F,
	1.204983209253790F,
	1.151629304421560F,
	1.093070216931180F,
	1.029641076216490F,
	0.961701152709717F,
	0.889630858282442F,
	0.813828612612482F,
	0.734707610279765F,
	0.652692523854560F,
	0.568216178210032F,
	0.481716230780643F,
	0.393631891518568F,
	0.304400714899947F,
	0.214455494535438F,
	0.124221288785524F,
	0.034112603314752F,
	-0.055469246210602F,
	-0.144138571019063F,
	-0.231527528563885F,
	-0.317288110333313F,
	-0.401093887449023F,
	-0.482641506623339F,
	-0.561651932261103F,
	-0.637871433614129F,
	-0.711072318882710F,
	-0.781053420972107F,
	-0.847640342219378F,
	-0.910685467779908F,
	-0.970067759481250F,
	-1.025692343797820F,
	-1.077489909162510F,
	-1.125415929104450F,
	-1.169449728685210F,
	-1.209593412403220F,
	-1.245870672155600F,
	-1.278325494001240F,
	-1.307020782374310F,
	-1.332036920071530F,
	-1.353470281801300F,
	-1.371431718360720F,
	-1.386045027620770F,
	-1.397445427476920F,
	-1.405778044785130F,
	-1.411196433077990F,
	-1.413861130565440F,
	-1.413938268593140F,
	-1.411598239379780F,
	-1.407014430503790F,
	-1.400362032276770F,
	-1.391816922844190F,
	-1.381554634604800F,
	-1.369749404354510F,
	-1.356573308445240F,
	-1.342195483214830F,
	-1.326781429995460F,
	-1.310492403149960F,
	-1.293484878819880F,
	-1.275910101398160F,
	-1.257913704160480F,
	-1.239635400002900F,
	-1.221208737834640F,
	-1.202760919861110F,
	-1.184412674758120F,
	-1.166278181578710F,
	-1.148465039143720F,
	-1.131074275639590F,
	-1.114200393176780F,
	-1.097931442142050F,
	-1.082349120303800F,
	-1.067528891793620F,
	-1.053540121285410F,
	-1.040446218919910F,
	-1.028304791772340F,
	-1.017167797930620F,
	-1.007081699535990F,
	-0.998087611435014F,
	-0.990221442397787F,
	-0.983514026169386F,
	-0.977991239938984F,
	-0.973674108130768F,
	-0.970578889742614F,
	-0.968717147780959F
};

volatile const FL CAFL_D_MODE_VECTOR_1[180] = {
	0.351700610663408F,
	0.351975877303754F,
	0.352801508058225F,
	0.354176994916178F,
	0.356101489493237F,
	0.358573800492355F,
	0.361592390171319F,
	0.365155369838664F,
	0.369260494406150F,
	0.373905156032096F,
	0.379086376895925F,
	0.384800801150244F,
	0.391044686102634F,
	0.397813892685076F,
	0.405103875274525F,
	0.412909670933594F,
	0.421225888145534F,
	0.430046695122793F,
	0.439365807773221F,
	0.449176477412614F,
	0.459471478316576F,
	0.470243095208699F,
	0.481483110785793F,
	0.493182793384201F,
	0.505332884894267F,
	0.517923589032575F,
	0.530944560083754F,
	0.544384892225348F,
	0.558233109550459F,
	0.572477156903637F,
	0.587104391645648F,
	0.602101576462403F,
	0.617454873332428F,
	0.633149838765687F,
	0.649171420424472F,
	0.665503955234271F,
	0.682131169089154F,
	0.699036178252130F,
	0.716201492546211F,
	0.733609020426568F,
	0.751240076018088F,
	0.769075388195967F,
	0.787095111779649F,
	0.805278840902404F,
	0.823605624610316F,
	0.842053984735243F,
	0.860601936076588F,
	0.879227008916478F,
	0.897906273882212F,
	0.916616369158647F,
	0.935333530041632F,
	0.954033620811704F,
	0.972692168895044F,
	0.991284401266344F,
	1.009785283035630F,
	1.028169558148540F,
	1.046411792116820F,
	1.064486416683420F,
	1.082367776314000F,
	1.100030176394640F,
	1.117447933003670F,
	1.134595424114000F,
	1.151447142071650F,
	1.167977747185500F,
	1.184162122253700F,
	1.199975427843230F,
	1.215393158130850F,
	1.230391197106180F,
	1.244945874931720F,
	1.259034024248660F,
	1.272633036213630F,
	1.285720916047760F,
	1.298276337877880F,
	1.310278698648460F,
	1.321708170883530F,
	1.332545754079250F,
	1.342773324510770F,
	1.352373683241100F,
	1.361330602125070F,
	1.369628867608010F,
	1.377254322126800F,
	1.384193902929400F,
	1.390435678139850F,
	1.395968879905930F,
	1.400783934479870F,
	1.404872489094600F,
	1.408227435512990F,
	1.410842930141420F,
	1.412714410615140F,
	1.413838608778520F,
	1.414213560000000F,
	1.413838608778520F,
	1.412714410615140F,
	1.410842930141420F,
	1.408227435512990F,
	1.404872489094600F,
	1.400783934479870F,
	1.395968879905930F,
	1.390435678139850F,
	1.384193902929400F,
	1.377254322126800F,
	1.369628867608010F,
	1.361330602125070F,
	1.352373683241100F,
	1.342773324510770F,
	1.332545754079250F,
	1.321708170883530F,
	1.310278698648460F,
	1.298276337877880F,
	1.285720916047760F,
	1.272633036213630F,
	1.259034024248660F,
	1.244945874931720F,
	1.230391197106180F,
	1.215393158130850F,
	1.199975427843230F,
	1.184162122253700F,
	1.167977747185500F,
	1.151447142071650F,
	1.134595424114000F,
	1.117447933003670F,
	1.100030176394640F,
	1.082367776314000F,
	1.064486416683420F,
	1.046411792116820F,
	1.028169558148540F,
	1.009785283035630F,
	0.991284401266344F,
	0.972692168895044F,
	0.954033620811704F,
	0.935333530041632F,
	0.916616369158647F,
	0.897906273882212F,
	0.879227008916478F,
	0.860601936076588F,
	0.842053984735243F,
	0.823605624610316F,
	0.805278840902404F,
	0.787095111779649F,
	0.769075388195967F,
	0.751240076018088F,
	0.733609020426568F,
	0.716201492546211F,
	0.699036178252130F,
	0.682131169089154F,
	0.665503955234271F,
	0.649171420424472F,
	0.633149838765687F,
	0.617454873332428F,
	0.602101576462403F,
	0.587104391645648F,
	0.572477156903637F,
	0.558233109550459F,
	0.544384892225348F,
	0.530944560083754F,
	0.517923589032575F,
	0.505332884894267F,
	0.493182793384201F,
	0.481483110785793F,
	0.470243095208699F,
	0.459471478316576F,
	0.449176477412614F,
	0.439365807773221F,
	0.430046695122793F,
	0.421225888145534F,
	0.412909670933594F,
	0.405103875274525F,
	0.397813892685076F,
	0.391044686102634F,
	0.384800801150244F,
	0.379086376895925F,
	0.373905156032096F,
	0.369260494406150F,
	0.365155369838664F,
	0.361592390171319F,
	0.358573800492355F,
	0.356101489493237F,
	0.354176994916178F,
	0.352801508058225F,
	0.351975877303754F
};

volatile const FL CAFL_D_MODE_VECTOR_2[180] = {
	-1.030917317713950F,
	-1.030333480424180F,
	-1.028579900675620F,
	-1.025650390944020F,
	-1.021534692455660F,
	-1.016218556028160F,
	-1.009683855621910F,
	-1.001908734959340F,
	-0.992867787647270F,
	-0.982532271297406F,
	-0.970870356178370F,
	-0.957847408945257F,
	-0.943426311976611F,
	-0.927567818800199F,
	-0.910230946005165F,
	-0.891373401916250F,
	-0.870952052143272F,
	-0.848923421914040F,
	-0.825244234849598F,
	-0.799871987546334F,
	-0.772765558989392F,
	-0.743885853436353F,
	-0.713196474980211F,
	-0.680664431528130F,
	-0.646260865419780F,
	-0.609961807360113F,
	-0.571748949760469F,
	-0.531610434974824F,
	-0.489541653291183F,
	-0.445546044899506F,
	-0.399635899415725F,
	-0.351833145906329F,
	-0.302170125740243F,
	-0.250690340006152F,
	-0.197449162686339F,
	-0.142514510285730F,
	-0.085967458190700F,
	-0.027902793690250F,
	0.031570504653551F,
	0.092328871734807F,
	0.154233855193870F,
	0.217131919605883F,
	0.280854365633906F,
	0.345217373783591F,
	0.410022181800659F,
	0.475055403983817F,
	0.540089499740098F,
	0.604883397585322F,
	0.669183279491073F,
	0.732723529005721F,
	0.795227844938774F,
	0.856410520606702F,
	0.915977886709515F,
	0.973629913859681F,
	1.029061968640810F,
	1.081966714858810F,
	1.132036149391920F,
	1.178963759780440F,
	1.222446788456100F,
	1.262188586332060F,
	1.297901036395010F,
	1.329307025999720F,
	1.356142944802980F,
	1.378161183725980F,
	1.395132609039360F,
	1.406848984657720F,
	1.413125315042050F,
	1.413802080767660F,
	1.408747338844100F,
	1.397858660291320F,
	1.381064878293660F,
	1.358327621477010F,
	1.329642608481830F,
	1.295040682028270F,
	1.254588563072470F,
	1.208389308412180F,
	1.156582458184940F,
	1.099343863074480F,
	1.036885184658690F,
	0.969453066143802F,
	0.897327974681438F,
	0.820822720497782F,
	0.740280662116956F,
	0.656073610968913F,
	0.568599452572562F,
	0.478279505213113F,
	0.385555640527345F,
	0.290887193612667F,
	0.194747693131285F,
	0.097621444340322F,
	0.000000000000000F,
	-0.097621444340322F,
	-0.194747693131285F,
	-0.290887193612667F,
	-0.385555640527345F,
	-0.478279505213113F,
	-0.568599452572562F,
	-0.656073610968913F,
	-0.740280662116956F,
	-0.820822720497782F,
	-0.897327974681438F,
	-0.969453066143802F,
	-1.036885184658690F,
	-1.099343863074480F,
	-1.156582458184940F,
	-1.208389308412180F,
	-1.254588563072470F,
	-1.295040682028270F,
	-1.329642608481830F,
	-1.358327621477010F,
	-1.381064878293660F,
	-1.397858660291320F,
	-1.408747338844100F,
	-1.413802080767660F,
	-1.413125315042050F,
	-1.406848984657720F,
	-1.395132609039360F,
	-1.378161183725980F,
	-1.356142944802980F,
	-1.329307025999720F,
	-1.297901036395010F,
	-1.262188586332060F,
	-1.222446788456100F,
	-1.178963759780440F,
	-1.132036149391920F,
	-1.081966714858810F,
	-1.029061968640810F,
	-0.973629913859681F,
	-0.915977886709515F,
	-0.856410520606702F,
	-0.795227844938774F,
	-0.732723529005721F,
	-0.669183279491073F,
	-0.604883397585322F,
	-0.540089499740098F,
	-0.475055403983817F,
	-0.410022181800659F,
	-0.345217373783591F,
	-0.280854365633906F,
	-0.217131919605883F,
	-0.154233855193870F,
	-0.092328871734807F,
	-0.031570504653551F,
	0.027902793690250F,
	0.085967458190700F,
	0.142514510285730F,
	0.197449162686339F,
	0.250690340006152F,
	0.302170125740243F,
	0.351833145906329F,
	0.399635899415725F,
	0.445546044899506F,
	0.489541653291183F,
	0.531610434974824F,
	0.571748949760469F,
	0.609961807360113F,
	0.646260865419780F,
	0.680664431528130F,
	0.713196474980211F,
	0.743885853436353F,
	0.772765558989392F,
	0.799871987546334F,
	0.825244234849598F,
	0.848923421914040F,
	0.870952052143272F,
	0.891373401916250F,
	0.910230946005165F,
	0.927567818800199F,
	0.943426311976611F,
	0.957847408945257F,
	0.970870356178370F,
	0.982532271297406F,
	0.992867787647270F,
	1.001908734959340F,
	1.009683855621910F,
	1.016218556028160F,
	1.021534692455660F,
	1.025650390944020F,
	1.028579900675620F,
	1.030333480424180F
};

volatile const FL CAFL_D_MODE_VECTOR_3[180] = {
	1.369783440455780F,
	1.369712734511920F,
	1.369500306389050F,
	1.369145225883660F,
	1.368645944891730F,
	1.368000300763250F,
	1.367205521001900F,
	1.366258229313130F,
	1.365154453004790F,
	1.363889631744620F,
	1.362458627680050F,
	1.360855736925120F,
	1.359074702420280F,
	1.357108728169790F,
	1.354950494861500F,
	1.352592176872760F,
	1.350025460665050F,
	1.347241564568820F,
	1.344231259957770F,
	1.340984893810170F,
	1.337492412651920F,
	1.333743387873550F,
	1.329727042409800F,
	1.325432278767060F,
	1.320847708379850F,
	1.315961682273270F,
	1.310762323003430F,
	1.305237557843270F,
	1.299375153175360F,
	1.293162750047880F,
	1.286587900844040F,
	1.279638107008920F,
	1.272300857771430F,
	1.264563669792410F,
	1.256414127663310F,
	1.247839925172860F,
	1.238828907252710F,
	1.229369112505490F,
	1.219448816212660F,
	1.209056573712180F,
	1.198181264029870F,
	1.186812133641670F,
	1.174938840238270F,
	1.162551496357370F,
	1.149640712743820F,
	1.136197641292820F,
	1.122214017426760F,
	1.107682201752680F,
	1.092595220843860F,
	1.076946806986440F,
	1.060731436730210F,
	1.043944368081360F,
	1.026581676174930F,
	1.008640287264940F,
	0.990118010871694F,
	0.971013569928097F,
	0.951326628769917F,
	0.931057818819200F,
	0.910208761815092F,
	0.888782090452458F,
	0.866781466295687F,
	0.844211594843052F,
	0.821078237625926F,
	0.797388221236906F,
	0.773149443191611F,
	0.748370874540375F,
	0.723062559158330F,
	0.697235609655362F,
	0.670902199861034F,
	0.644075553853817F,
	0.616769931518682F,
	0.589000610632269F,
	0.560783865490332F,
	0.532136942107924F,
	0.503078030038666F,
	0.473626230875397F,
	0.443801523510413F,
	0.413624726249248F,
	0.383117455887456F,
	0.352302083874991F,
	0.321201689707470F,
	0.289840011697728F,
	0.258241395294521F,
	0.226430739127987F,
	0.194433438973289F,
	0.162275329834864F,
	0.129982626363594F,
	0.097581861828106F,
	0.065099825869113F,
	0.032563501272233F,
	0.000000000000000F,
	-0.032563501272233F,
	-0.065099825869113F,
	-0.097581861828106F,
	-0.129982626363594F,
	-0.162275329834864F,
	-0.194433438973289F,
	-0.226430739127987F,
	-0.258241395294521F,
	-0.289840011697728F,
	-0.321201689707470F,
	-0.352302083874991F,
	-0.383117455887456F,
	-0.413624726249248F,
	-0.443801523510413F,
	-0.473626230875397F,
	-0.503078030038666F,
	-0.532136942107924F,
	-0.560783865490332F,
	-0.589000610632269F,
	-0.616769931518682F,
	-0.644075553853817F,
	-0.670902199861034F,
	-0.697235609655362F,
	-0.723062559158330F,
	-0.748370874540375F,
	-0.773149443191611F,
	-0.797388221236906F,
	-0.821078237625926F,
	-0.844211594843052F,
	-0.866781466295687F,
	-0.888782090452458F,
	-0.910208761815092F,
	-0.931057818819200F,
	-0.951326628769917F,
	-0.971013569928097F,
	-0.990118010871694F,
	-1.008640287264940F,
	-1.026581676174930F,
	-1.043944368081360F,
	-1.060731436730210F,
	-1.076946806986440F,
	-1.092595220843860F,
	-1.107682201752680F,
	-1.122214017426760F,
	-1.136197641292820F,
	-1.149640712743820F,
	-1.162551496357370F,
	-1.174938840238270F,
	-1.186812133641670F,
	-1.198181264029870F,
	-1.209056573712180F,
	-1.219448816212660F,
	-1.229369112505490F,
	-1.238828907252710F,
	-1.247839925172860F,
	-1.256414127663310F,
	-1.264563669792410F,
	-1.272300857771430F,
	-1.279638107008920F,
	-1.286587900844040F,
	-1.293162750047880F,
	-1.299375153175360F,
	-1.305237557843270F,
	-1.310762323003430F,
	-1.315961682273270F,
	-1.320847708379850F,
	-1.325432278767060F,
	-1.329727042409800F,
	-1.333743387873550F,
	-1.337492412651920F,
	-1.340984893810170F,
	-1.344231259957770F,
	-1.347241564568820F,
	-1.350025460665050F,
	-1.352592176872760F,
	-1.354950494861500F,
	-1.357108728169790F,
	-1.359074702420280F,
	-1.360855736925120F,
	-1.362458627680050F,
	-1.363889631744620F,
	-1.365154453004790F,
	-1.366258229313130F,
	-1.367205521001900F,
	-1.368000300763250F,
	-1.368645944891730F,
	-1.369145225883660F,
	-1.369500306389050F,
	-1.369712734511920F
};

volatile const FL CAFL_D_MODE_VECTOR_2DN[180] = {
	1.030917317713950F,
	1.030333480424180F,
	1.028579900675620F,
	1.025650390944020F,
	1.021534692455660F,
	1.016218556028160F,
	1.009683855621910F,
	1.001908734959340F,
	0.992867787647270F,
	0.982532271297406F,
	0.970870356178370F,
	0.957847408945257F,
	0.943426311976611F,
	0.927567818800199F,
	0.910230946005165F,
	0.891373401916250F,
	0.870952052143272F,
	0.848923421914040F,
	0.825244234849598F,
	0.799871987546334F,
	0.772765558989392F,
	0.743885853436353F,
	0.713196474980211F,
	0.680664431528130F,
	0.646260865419780F,
	0.609961807360113F,
	0.571748949760469F,
	0.531610434974824F,
	0.489541653291183F,
	0.445546044899506F,
	0.399635899415725F,
	0.351833145906329F,
	0.302170125740243F,
	0.250690340006152F,
	0.197449162686339F,
	0.142514510285730F,
	0.085967458190700F,
	0.027902793690250F,
	-0.031570504653551F,
	-0.092328871734807F,
	-0.154233855193870F,
	-0.217131919605883F,
	-0.280854365633906F,
	-0.345217373783591F,
	-0.410022181800659F,
	-0.475055403983817F,
	-0.540089499740098F,
	-0.604883397585322F,
	-0.669183279491073F,
	-0.732723529005721F,
	-0.795227844938774F,
	-0.856410520606702F,
	-0.915977886709515F,
	-0.973629913859681F,
	-1.029061968640810F,
	-1.081966714858810F,
	-1.132036149391920F,
	-1.178963759780440F,
	-1.222446788456100F,
	-1.262188586332060F,
	-1.297901036395010F,
	-1.329307025999720F,
	-1.356142944802980F,
	-1.378161183725980F,
	-1.395132609039360F,
	-1.406848984657720F,
	-1.413125315042050F,
	-1.413802080767660F,
	-1.408747338844100F,
	-1.397858660291320F,
	-1.381064878293660F,
	-1.358327621477010F,
	-1.329642608481830F,
	-1.295040682028270F,
	-1.254588563072470F,
	-1.208389308412180F,
	-1.156582458184940F,
	-1.099343863074480F,
	-1.036885184658690F,
	-0.969453066143802F,
	-0.897327974681438F,
	-0.820822720497782F,
	-0.740280662116956F,
	-0.656073610968913F,
	-0.568599452572562F,
	-0.478279505213113F,
	-0.385555640527345F,
	-0.290887193612667F,
	-0.194747693131285F,
	-0.097621444340322F,
	-0.000000000000000F,
	0.097621444340322F,
	0.194747693131285F,
	0.290887193612667F,
	0.385555640527345F,
	0.478279505213113F,
	0.568599452572562F,
	0.656073610968913F,
	0.740280662116956F,
	0.820822720497782F,
	0.897327974681438F,
	0.969453066143802F,
	1.036885184658690F,
	1.099343863074480F,
	1.156582458184940F,
	1.208389308412180F,
	1.254588563072470F,
	1.295040682028270F,
	1.329642608481830F,
	1.358327621477010F,
	1.381064878293660F,
	1.397858660291320F,
	1.408747338844100F,
	1.413802080767660F,
	1.413125315042050F,
	1.406848984657720F,
	1.395132609039360F,
	1.378161183725980F,
	1.356142944802980F,
	1.329307025999720F,
	1.297901036395010F,
	1.262188586332060F,
	1.222446788456100F,
	1.178963759780440F,
	1.132036149391920F,
	1.081966714858810F,
	1.029061968640810F,
	0.973629913859681F,
	0.915977886709515F,
	0.856410520606702F,
	0.795227844938774F,
	0.732723529005721F,
	0.669183279491073F,
	0.604883397585322F,
	0.540089499740098F,
	0.475055403983817F,
	0.410022181800659F,
	0.345217373783591F,
	0.280854365633906F,
	0.217131919605883F,
	0.154233855193870F,
	0.092328871734807F,
	0.031570504653551F,
	-0.027902793690250F,
	-0.085967458190700F,
	-0.142514510285730F,
	-0.197449162686339F,
	-0.250690340006152F,
	-0.302170125740243F,
	-0.351833145906329F,
	-0.399635899415725F,
	-0.445546044899506F,
	-0.489541653291183F,
	-0.531610434974824F,
	-0.571748949760469F,
	-0.609961807360113F,
	-0.646260865419780F,
	-0.680664431528130F,
	-0.713196474980211F,
	-0.743885853436353F,
	-0.772765558989392F,
	-0.799871987546334F,
	-0.825244234849598F,
	-0.848923421914040F,
	-0.870952052143272F,
	-0.891373401916250F,
	-0.910230946005165F,
	-0.927567818800199F,
	-0.943426311976611F,
	-0.957847408945257F,
	-0.970870356178370F,
	-0.982532271297406F,
	-0.992867787647270F,
	-1.001908734959340F,
	-1.009683855621910F,
	-1.016218556028160F,
	-1.021534692455660F,
	-1.025650390944020F,
	-1.028579900675620F,
	-1.030333480424180F
};

volatile const FL CAFL_D_MODE_VECTOR_3DN[180] = {
	-1.369783440455780F,
	-1.369712734511920F,
	-1.369500306389050F,
	-1.369145225883660F,
	-1.368645944891730F,
	-1.368000300763250F,
	-1.367205521001900F,
	-1.366258229313130F,
	-1.365154453004790F,
	-1.363889631744620F,
	-1.362458627680050F,
	-1.360855736925120F,
	-1.359074702420280F,
	-1.357108728169790F,
	-1.354950494861500F,
	-1.352592176872760F,
	-1.350025460665050F,
	-1.347241564568820F,
	-1.344231259957770F,
	-1.340984893810170F,
	-1.337492412651920F,
	-1.333743387873550F,
	-1.329727042409800F,
	-1.325432278767060F,
	-1.320847708379850F,
	-1.315961682273270F,
	-1.310762323003430F,
	-1.305237557843270F,
	-1.299375153175360F,
	-1.293162750047880F,
	-1.286587900844040F,
	-1.279638107008920F,
	-1.272300857771430F,
	-1.264563669792410F,
	-1.256414127663310F,
	-1.247839925172860F,
	-1.238828907252710F,
	-1.229369112505490F,
	-1.219448816212660F,
	-1.209056573712180F,
	-1.198181264029870F,
	-1.186812133641670F,
	-1.174938840238270F,
	-1.162551496357370F,
	-1.149640712743820F,
	-1.136197641292820F,
	-1.122214017426760F,
	-1.107682201752680F,
	-1.092595220843860F,
	-1.076946806986440F,
	-1.060731436730210F,
	-1.043944368081360F,
	-1.026581676174930F,
	-1.008640287264940F,
	-0.990118010871694F,
	-0.971013569928097F,
	-0.951326628769917F,
	-0.931057818819200F,
	-0.910208761815092F,
	-0.888782090452458F,
	-0.866781466295687F,
	-0.844211594843052F,
	-0.821078237625926F,
	-0.797388221236906F,
	-0.773149443191611F,
	-0.748370874540375F,
	-0.723062559158330F,
	-0.697235609655362F,
	-0.670902199861034F,
	-0.644075553853817F,
	-0.616769931518682F,
	-0.589000610632269F,
	-0.560783865490332F,
	-0.532136942107924F,
	-0.503078030038666F,
	-0.473626230875397F,
	-0.443801523510413F,
	-0.413624726249248F,
	-0.383117455887456F,
	-0.352302083874991F,
	-0.321201689707470F,
	-0.289840011697728F,
	-0.258241395294521F,
	-0.226430739127987F,
	-0.194433438973289F,
	-0.162275329834864F,
	-0.129982626363594F,
	-0.097581861828106F,
	-0.065099825869113F,
	-0.032563501272233F,
	-0.000000000000000F,
	0.032563501272233F,
	0.065099825869113F,
	0.097581861828106F,
	0.129982626363594F,
	0.162275329834864F,
	0.194433438973289F,
	0.226430739127987F,
	0.258241395294521F,
	0.289840011697728F,
	0.321201689707470F,
	0.352302083874991F,
	0.383117455887456F,
	0.413624726249248F,
	0.443801523510413F,
	0.473626230875397F,
	0.503078030038666F,
	0.532136942107924F,
	0.560783865490332F,
	0.589000610632269F,
	0.616769931518682F,
	0.644075553853817F,
	0.670902199861034F,
	0.697235609655362F,
	0.723062559158330F,
	0.748370874540375F,
	0.773149443191611F,
	0.797388221236906F,
	0.821078237625926F,
	0.844211594843052F,
	0.866781466295687F,
	0.888782090452458F,
	0.910208761815092F,
	0.931057818819200F,
	0.951326628769917F,
	0.971013569928097F,
	0.990118010871694F,
	1.008640287264940F,
	1.026581676174930F,
	1.043944368081360F,
	1.060731436730210F,
	1.076946806986440F,
	1.092595220843860F,
	1.107682201752680F,
	1.122214017426760F,
	1.136197641292820F,
	1.149640712743820F,
	1.162551496357370F,
	1.174938840238270F,
	1.186812133641670F,
	1.198181264029870F,
	1.209056573712180F,
	1.219448816212660F,
	1.229369112505490F,
	1.238828907252710F,
	1.247839925172860F,
	1.256414127663310F,
	1.264563669792410F,
	1.272300857771430F,
	1.279638107008920F,
	1.286587900844040F,
	1.293162750047880F,
	1.299375153175360F,
	1.305237557843270F,
	1.310762323003430F,
	1.315961682273270F,
	1.320847708379850F,
	1.325432278767060F,
	1.329727042409800F,
	1.333743387873550F,
	1.337492412651920F,
	1.340984893810170F,
	1.344231259957770F,
	1.347241564568820F,
	1.350025460665050F,
	1.352592176872760F,
	1.354950494861500F,
	1.357108728169790F,
	1.359074702420280F,
	1.360855736925120F,
	1.362458627680050F,
	1.363889631744620F,
	1.365154453004790F,
	1.366258229313130F,
	1.367205521001900F,
	1.368000300763250F,
	1.368645944891730F,
	1.369145225883660F,
	1.369500306389050F,
	1.369712734511920F
};

/* 行列の積 */
VD fn_matmul_4x4(
	FL afl_a_mat_A[4][4],
	FL afl_a_mat_B[4][4],
	FL afl_a_mat_C[4][4]
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;
	S4 s4_t_lp_k;

	FL fl_t_res_s;
	for (s4_t_lp_k = 0; s4_t_lp_k < 4; s4_t_lp_k++ ) {
		for (s4_t_lp_i = 0; s4_t_lp_i < 4; s4_t_lp_i++ ) {
			fl_t_res_s = 0.0;
			for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++ ) {
				fl_t_res_s += afl_a_mat_A[s4_t_lp_i][s4_t_lp_j] * afl_a_mat_B[s4_t_lp_j][s4_t_lp_k];
			}
			afl_a_mat_C[s4_t_lp_i][s4_t_lp_k] = fl_t_res_s;
		}
	}
	return;
}



/* ＭＵＳＩＣ処理 */
VD fn_calc_spec_music_4ch(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],	/*  [in] */
	FL afl_a_spec_music[N_DOA],			/*  [out] */
	S4 s4_a_wave_num,					/*  [in] */
	S4 s4_a_updn_flg					/*  [in] */
)
{
	FL afl_t_eigen_vec[4][4];
	s4_calc_eigen_vector_4ch(
		(const FL *)afl_a_Ryy,	/*  [in] */
		afl_t_eigen_vec			/*  [out] */
	);
#if (MODE_ECU_SIM == ECU_MODE)
	/* ToDo：暫定的に全角度実施するasm関数を利用する */
	fn_cmn_matrix_spec_4ch(
		afl_t_eigen_vec,		/*  [in] */
		afl_a_spec_music,		/*  [out] afl_a_spec_music[61]? [81]? */
		(U4)s4_a_wave_num,			/*  [in] */
		(U4)s4_a_updn_flg			/*  [in] */
	);
#elif (MODE_ECU_SIM == SIM_MODE) /* MODE_ECU_SIM */
	fn_matrix_spec_4ch(
		afl_t_eigen_vec,		/*  [in] */
		afl_a_spec_music,		/*  [out] afl_a_spec_music[61]? [81]? */
		s4_a_wave_num,			/*  [in] */
		s4_a_updn_flg,			/*  [in] */
/* 		fl_a_installed_angle	 _20140108_1 */
		(S4)((N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - CU1_DOA_BIN_LOWER_LIMIT),								/* _20140113_4 */
		(S4)((N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - CU1_DOA_BIN_LOWER_LIMIT + CU1_DOA_BIN_UPPER_LIMIT)	/* _20140113_4 */
	);
#endif /* MODE_ECU_SIM */
}

/****************************************************************************/
/* 関数名		: s4_calc_spec_music_4ch_all								*/
/*--------------------------------------------------------------------------*/
/* 機能			: 															*/
/*--------------------------------------------------------------------------*/
/* 引数			: 															*/
/* 戻り値		: 															*/
/*--------------------------------------------------------------------------*/
/* グローバル変数アクセス													*/
/* <input>																	*/
/* <output>																	*/
/*--------------------------------------------------------------------------*/
/* 参照関数 	: 															*/
/*--------------------------------------------------------------------------*/
/* 作成者   	: 															*/
/*--------------------------------------------------------------------------*/
/* 注意事項		: 本関数に対応する仕様を、納入先検査が参照している。		*/
/* 				: 本関数の変更時には、参照元関数も併せて変更すること。		*/
/* 参照元		: s4_fact_cmn_calc_spec_music_4ch()							*/
/****************************************************************************/
S4 s4_calc_spec_music_4ch_all(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],	/*  [in] */
	FL afl_a_spec_music[N_DOA],			/*  [out] */
	S4 s4_a_wave_num,					/*  [in] */
	S4 s4_a_updn_flg					/*  [in] */
)
{
	FL afl_t_eigen_vec[4][4];
	S4 s4_t_temp_wave_num = s4_a_wave_num;
	s4_t_temp_wave_num = s4_calc_eigen_vector_4ch(		/*  到来波数推定(1 or 2) */
		(const FL *)afl_a_Ryy,	/*  [in] */
		afl_t_eigen_vec			/*  [out] */
	);
	/*  要求が到来波１の時は１にする */
	if ((s4_a_wave_num == 1) && (s4_t_temp_wave_num >= 2)) {
		s4_t_temp_wave_num = 1;
	}
#if (MODE_ECU_SIM == ECU_MODE)
	fn_cmn_matrix_spec_4ch(
		afl_t_eigen_vec,		/*  [in] */
		afl_a_spec_music,		/*  [out] afl_a_spec_music[61]? [81]? */
		(U4)s4_t_temp_wave_num,		/*  [in] */
		(U4)s4_a_updn_flg			/*  [in] */
	);
#elif (MODE_ECU_SIM == SIM_MODE) /* MODE_ECU_SIM */
	fn_matrix_spec_4ch_all(
		afl_t_eigen_vec,		/*  [in] */
		afl_a_spec_music,		/*  [out] afl_a_spec_music[61]? [81]? */
		s4_t_temp_wave_num,		/*  [in] */
		s4_a_updn_flg			/*  [in] */
	);
#endif /* MODE_ECU_SIM */

#if (BSM_OPTION_SW_RECOG_02 == TYPE_A)
	/* 搭載角度50degでは処理なし */
#elif (BSM_OPTION_SW_RECOG_02 == TYPE_B)
	/* 到来波数が2より大きいときは2に制限する */
	/* 後段の処理が最大到来波数2を前提で作成されているため */
	if (s4_t_temp_wave_num > (S4)2) {
		s4_t_temp_wave_num = (S4)2;
	}
#else
	マクロ未定義の場合は、コンパイルエラーとする
#endif /* BSM_OPTION_SW_RECOG_02 */

	return (s4_t_temp_wave_num);
}

S4 s4_calc_spec_music_4ch_all_2wavefix(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],	/*  [in] */
	FL afl_a_spec_music[N_DOA],			/*  [out] */
	S4 s4_a_updn_flg					/*  [in] */
)
{
	FL afl_t_eigen_vec[4][4];
	S4 s4_t_temp_wave_num = 2;
	s4_t_temp_wave_num = s4_calc_eigen_vector_4ch(		/* $$$ 2013.07.09 到来波数推定(1 or 2) */
		(const FL *)afl_a_Ryy,	/*  [in] */
		afl_t_eigen_vec			/*  [out] */
	);

#if (MODE_ECU_SIM == ECU_MODE)
	fn_cmn_matrix_spec_4ch(
		afl_t_eigen_vec,		/*  [in] */
		afl_a_spec_music,		/*  [out] afl_a_spec_music[61]? [81]? */
		(U4)2,						/*  [in] */
		(U4)s4_a_updn_flg			/*  [in] */
	);
#elif (MODE_ECU_SIM == SIM_MODE) /* MODE_ECU_SIM */
	fn_matrix_spec_4ch_all(
		afl_t_eigen_vec,		/*  [in] */
		afl_a_spec_music,		/*  [out] afl_a_spec_music[61]? [81]? */
		2,						/*  [in] */
		s4_a_updn_flg			/*  [in] */
	);
#endif /* MODE_ECU_SIM */
	return 2;
}

/* beam former */
/* @param :see below */
VD fn_calc_spec_bf_4ch_fm(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],		/*  [in] correlation matrix */
	FL afl_a_spec_bf[N_DOA],				/*  [out] beam forming spectrum */
	S4 s4_a_updn_flg,						/*  [in] direction of beat-signal */
	S4 s4_a_freq_bin						/*  [in] s4_a_freq_bin	$$$ 2013.08.22-1 */
)
{
	S4 s4_t_lp_i;
#if (MODE_ECU_SIM == ECU_MODE)
	fn_cmn_bf_spec_sub_asm(
#elif (MODE_ECU_SIM == SIM_MODE)
	fn_calc_spec_bf_4ch(
#endif /* MODE_ECU_SIM */
		afl_a_Ryy,
		afl_a_spec_bf,
		s4_a_updn_flg
	);
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		afl_a_spec_bf[s4_t_lp_i] = afl_a_spec_bf[s4_t_lp_i] - CAFL_D_FIL_CAL[s4_a_freq_bin];
	}
}

/****************************************************************************/
/* 関数名		: fl_calc_spec_bf_4ch_fm_of_specified_doa					*/
/*--------------------------------------------------------------------------*/
/* 機能			: 															*/
/*--------------------------------------------------------------------------*/
/* 引数			: 															*/
/* 戻り値		: 															*/
/*--------------------------------------------------------------------------*/
/* グローバル変数アクセス													*/
/* <input>																	*/
/* <output>																	*/
/*--------------------------------------------------------------------------*/
/* 参照関数 	: 															*/
/*--------------------------------------------------------------------------*/
/* 作成者   	: 															*/
/*--------------------------------------------------------------------------*/
/* 注意事項		: 本関数に対応する仕様を、納入先検査が参照している。		*/
/* 				: 本関数の変更時には、参照元関数も併せて変更すること。		*/
/* 参照元		: fl_fact_cmn_calc_spec_bf_4ch_fm()							*/
/****************************************************************************/
FL fl_calc_spec_bf_4ch_fm_of_specified_doa(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],		/*  [in] correlation matrix */
	S4 s4_a_updn_flg,						/*  [in] direction of beat-signal */
	S4 s4_a_freq_bin,						/*  [in] s4_a_freq_bin */
	S4 s4_a_doa_bin							/*  [in] s4_a_doa_bin */
)
{
	FL fl_t_spec_bf = 0.0F;
	fl_t_spec_bf = fl_calc_spec_bf_4ch_of_specified_doa(
		(const FL *)afl_a_Ryy,
		s4_a_doa_bin,
		s4_a_updn_flg
	);
	fl_t_spec_bf = fl_t_spec_bf - CAFL_D_FIL_CAL[s4_a_freq_bin];
	return (fl_t_spec_bf);
}

FL fl_calc_spec_bf_4ch_2f_of_specified_doa(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],			/* [in] correlation matrix */
	S4 s4_a_freq_bin,							/* [in] freq_bin */
	S4 s4_a_doa_bin								/* [in] doa_bin */
)
{
	FL fl_t_spec_bf = 0.0F;
	fl_t_spec_bf = fl_calc_spec_bf_4ch_of_specified_doa(
		(const FL *)afl_a_Ryy,
		s4_a_doa_bin,
		1
	);
	fl_t_spec_bf = fl_t_spec_bf - CAFL_D_FIL_CAL_FSK[s4_a_freq_bin];
	return (fl_t_spec_bf);
}

VD fn_calc_spec_bf_4ch_2f(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],		/*  [in] correlation matrix */
	FL afl_a_spec_bf[N_DOA],				/*  [out] beam forming spectrum */
	S4 s4_a_updn_flg,						/*  [in] direction of beat-signal */
	S4 s4_a_freq_bin						/*  [in] s4_a_freq_bin	$$$ 2013.08.22-1 */
)
{
	S4 s4_t_lp_i;
#if (MODE_ECU_SIM == ECU_MODE)
	fn_cmn_bf_spec_sub_asm(
#elif (MODE_ECU_SIM == SIM_MODE)
	fn_calc_spec_bf_4ch(
#endif /* MODE_ECU_SIM */
		afl_a_Ryy,
		afl_a_spec_bf,
		s4_a_updn_flg
	);
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		afl_a_spec_bf[s4_t_lp_i] = afl_a_spec_bf[s4_t_lp_i] - CAFL_D_FIL_CAL_FSK[s4_a_freq_bin];
	}
}



/****************************************************************************/
/* 関数名		: fl_calc_spec_bf_4ch_of_specified_doa						*/
/*--------------------------------------------------------------------------*/
/* 機能			: 															*/
/*--------------------------------------------------------------------------*/
/* 引数			: 															*/
/* 戻り値		: 															*/
/*--------------------------------------------------------------------------*/
/* グローバル変数アクセス													*/
/* <input>																	*/
/* <output>																	*/
/*--------------------------------------------------------------------------*/
/* 参照関数 	: 															*/
/*--------------------------------------------------------------------------*/
/* 作成者   	: 															*/
/*--------------------------------------------------------------------------*/
/* 注意事項		: 本関数に対応する仕様を、納入先検査が参照している。		*/
/* 				: 本関数の変更時には、参照元関数も併せて変更すること。		*/
/* 参照元		: fl_fact_cmn_calc_spec_bf_4ch()							*/
/****************************************************************************/
FL fl_calc_spec_bf_4ch_of_specified_doa(
	const FL afl_a_Ryy[CORRE_SIZE_4CH],		/*  [in] correlation matrix */
	S4 s4_a_doa_bin,						/*  [in] doa-bin */
	S4 s4_a_updn_flg						/*  [in] direction of beat-signal */
)
{
	S4 s4_t_lp_j, s4_t_lp_k;
	FL afl_t_Ryy[4][4];
	FL afl_t_mode_vec[4];
	FL afl_t_Ryy_mode[4];
	FL fl_t_mode_sum = 4.0F;
	FL fl_t_Ryy_sum;
	FL fl_t_spec_bf;

	/**************** 相関行列 ********************/
	afl_t_Ryy[0][0] = afl_a_Ryy[0];
	afl_t_Ryy[0][1] = afl_a_Ryy[1];
	afl_t_Ryy[0][2] = afl_a_Ryy[3];
	afl_t_Ryy[0][3] = afl_a_Ryy[6];

	afl_t_Ryy[1][0] = afl_a_Ryy[1];
	afl_t_Ryy[1][1] = afl_a_Ryy[2];
	afl_t_Ryy[1][2] = afl_a_Ryy[4];
	afl_t_Ryy[1][3] = afl_a_Ryy[7];

	afl_t_Ryy[2][0] = afl_a_Ryy[3];
	afl_t_Ryy[2][1] = afl_a_Ryy[4];
	afl_t_Ryy[2][2] = afl_a_Ryy[5];
	afl_t_Ryy[2][3] = afl_a_Ryy[8];

	afl_t_Ryy[3][0] = afl_a_Ryy[6];
	afl_t_Ryy[3][1] = afl_a_Ryy[7];
	afl_t_Ryy[3][2] = afl_a_Ryy[8];
	afl_t_Ryy[3][3] = afl_a_Ryy[9];

	/*********** スペクトラム初期化 *****************/
	fl_t_spec_bf = 0.0F;

	/*********** conventional beamformer *****************/
	/* ウエイトベクトル											*/
	/*  W =  a(θ)												*/
	/* 出力電圧													*/
	/*       1													*/
	/*  P = --- * a(θ)' * R * a(θ)							*/
	/*       2 													*/
	/* 角度スペクトラム（正規化出力電圧）						*/
	/*                   P               a(θ)' * R * a(θ)		*/
	/*  SP(θ) = -------------------- = --------------------	*/
	/*            a'(θ) * a(θ) / 2       a'(θ) * a(θ)		*/

	/***********モードベクトル*****************/
	if (s4_a_updn_flg == 1) {
		afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_a_doa_bin];
		afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_a_doa_bin];
		afl_t_mode_vec[2] = -CAFL_D_MODE_VECTOR_2[s4_a_doa_bin];
		afl_t_mode_vec[3] = -CAFL_D_MODE_VECTOR_3[s4_a_doa_bin];
	} else {
		afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_a_doa_bin];
		afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_a_doa_bin];
		afl_t_mode_vec[2] =  CAFL_D_MODE_VECTOR_2[s4_a_doa_bin];
		afl_t_mode_vec[3] =  CAFL_D_MODE_VECTOR_3[s4_a_doa_bin];
	}

	/*  [afl_t_Ryy_mode] = [A] = Kx1 = 4x1 */
/* 		fl_t_mode_sum = 0; */
/* 		for (s4_t_lp_j=0; s4_t_lp_j<4; s4_t_lp_j++) */
/* 		{ */
/* 			fl_t_mode_sum += afl_t_mode_vec[s4_t_lp_j]*afl_t_mode_vec[s4_t_lp_j]; */
/* 		}	@@@ fl_t_mode_sum = 4でよい */
	fl_t_Ryy_sum = 0.0F;
	for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++ ) {
		afl_t_Ryy_mode[s4_t_lp_j] = 0.0F;
		for (s4_t_lp_k = 0; s4_t_lp_k < 4; s4_t_lp_k++ ) {
			afl_t_Ryy_mode[s4_t_lp_j] += afl_t_Ryy[s4_t_lp_j][s4_t_lp_k] * afl_t_mode_vec[s4_t_lp_k];
		}
		fl_t_Ryy_sum += afl_t_mode_vec[s4_t_lp_j] * afl_t_Ryy_mode[s4_t_lp_j];
	}
	fl_t_spec_bf = 10 * (FL)fl_log10( (0.25F * fl_t_Ryy_sum) / fl_t_mode_sum );	/* $$$ 2013.08.23-6 1/4し忘れバグ */

	return (fl_t_spec_bf);
}

/* peak search for MUSIC result */
/* @return :number of peaks ( MAX:2 ) */
/* @param :see below */
S4 s4_search_peak_music(
	const FL afl_a_music_spec[N_DOA],		/*  [in] spectrum power */
	S4 *ps4_a_bin_music,					/*  [out] DOA of MUSIC peak */
	FL *pfl_a_power_music,					/*  [out] power of MUSIC peak */
	S4 s4_a_wave_num						/*  [in/out] number of waves */
#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161116_BTT_DOA_RANGE_T)
	,S4 s4_object_type						/*  [in] object type */
#endif
)
{
	S4 s4_t_peak_num = 0;
#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161116_BTT_DOA_RANGE_T)
	S4 s4_doa_bin_lower_limit = (S4)0;//CU1_DOA_BIN_LOWER_LIMIT;
	S4 s4_doa_bin_upper_limit = (S4)0;//CU1_DOA_BIN_UPPER_LIMIT;
	/* change the doa searching range for trailer object only */
	if( s4_object_type == OBJECT_TYPE_TRAILER ) {
		s4_doa_bin_lower_limit = (S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT_T);
		s4_doa_bin_upper_limit = (S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT_T + (FL)CU1_DOA_BIN_UPPER_LIMIT_T);
		if( s4_doa_bin_lower_limit < (S4)0 ){
			s4_doa_bin_lower_limit == (S4)0;
		}
	} else{
		s4_doa_bin_lower_limit = (S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT);
		s4_doa_bin_upper_limit = (S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT + (FL)CU1_DOA_BIN_UPPER_LIMIT);
	}
#endif

	s4_t_peak_num = s4_search_peak_music_within_doa_range(
		(const FL *)afl_a_music_spec,
		ps4_a_bin_music,
		pfl_a_power_music,
		s4_a_wave_num,
#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161116_BTT_DOA_RANGE_T)
		s4_doa_bin_lower_limit,
		s4_doa_bin_upper_limit
		//(S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)u1_doa_bin_lower_limit),									/* _20140108_1	DOA_BIN_LOWER_LIMIT, */
		//(S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)u1_doa_bin_lower_limit + (FL)u1_doa_bin_upper_limit)		/* _20140108_1	DOA_BIN_UPPER_LIMIT */
#else
		(S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT),									/* _20140108_1	DOA_BIN_LOWER_LIMIT, */
		(S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT + (FL)CU1_DOA_BIN_UPPER_LIMIT)	/* _20140108_1	DOA_BIN_UPPER_LIMIT */
#endif
	);
	return (s4_t_peak_num);
}

S4 s4_search_peak_music_ex_sidewall(
	const FL afl_a_music_spec[N_DOA],	/*  [in] spectrum power */
	const FL afl_a_Ryy[CORRE_SIZE_4CH],	/*  [in] correlation matrix */
	S4 s4_a_freq_bin,					/*  [in] s4_a_freq_bin */
	S4 s4_a_updn_flg,						/*  [in] */
	S4 as4_a_bin_music[2],				/*  [out] DOA of MUSIC peak */
	FL afl_a_power_music[2],			/*  [out] power of MUSIC peak */
	S4 s4_a_wave_num					/*  [in/out] number of waves */
)
{
	S4 s4_t_iret = 0;
	S4 s4_t_peak_num = 0;
	S4 s4_t_lp_i;
	S4 as4_t_bin_music[2];		/*  [out] DOA of MUSIC peak */
	FL afl_t_power_music[2];	/*  [out] power of MUSIC peak */
	FL fl_t_pow_max = 0.0F;
	S4 s4_t_wave_index = -1;

	for (s4_t_lp_i = 0; s4_t_lp_i < 2; s4_t_lp_i++) {
		as4_t_bin_music[s4_t_lp_i] = 0;
		afl_t_power_music[s4_t_lp_i] = 0.0F;
	}

	s4_t_peak_num = s4_search_peak_music_within_doa_range(
		(const FL *)afl_a_music_spec,
		as4_t_bin_music,
		afl_t_power_music,
		s4_a_wave_num,
		(S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT),									/* _20140108_1	DOA_BIN_LOWER_LIMIT, */
		(S4)((FL)(N_DOA * 0.5F) - st_g_bsm_loop_data.afl_installed_angle[0] - (FL)CU1_DOA_BIN_LOWER_LIMIT + (FL)CU1_DOA_BIN_UPPER_LIMIT)	/* _20140108_1	DOA_BIN_UPPER_LIMIT */
	);
	for (s4_t_lp_i = 0; s4_t_lp_i < 2; s4_t_lp_i++) {
		if (as4_t_bin_music[s4_t_lp_i] > 0) {
			afl_t_power_music[s4_t_lp_i] = fl_calc_spec_bf_4ch_fm_of_specified_doa(
				afl_a_Ryy,
				s4_a_updn_flg,
				s4_a_freq_bin,
				as4_t_bin_music[s4_t_lp_i]
			);
		}
	}

	if (s4_t_peak_num > 1) {	/*  2方位以上 */
		for (s4_t_lp_i = 0; s4_t_lp_i < s4_t_peak_num; s4_t_lp_i++) {
			/*  真後過ぎから真横手前付近の壁のピークではないもので電力最大 */
			if (
				(as4_t_bin_music[s4_t_lp_i] < (N_DOA - (S4)st_g_bsm_loop_data.afl_installed_angle[0] - DOA_RANGE_FORWARD))
				 && (as4_t_bin_music[s4_t_lp_i] > (N_DOA - (S4)st_g_bsm_loop_data.afl_installed_angle[0] - (S4)CU1_DOA_RANGE_BACKWARD))
				 && (afl_t_power_music[s4_t_lp_i] > fl_t_pow_max)
			) {
				fl_t_pow_max = afl_t_power_music[s4_t_lp_i];
				s4_t_wave_index = s4_t_lp_i;
				s4_t_iret = 1;
			}
		}
		if (s4_t_iret != 0) {
			as4_a_bin_music[0] = as4_t_bin_music[s4_t_wave_index];
			afl_a_power_music[0] = afl_t_power_music[s4_t_wave_index];
		} else {
			as4_a_bin_music[0] = 0;
			afl_a_power_music[0] = 0.0F;
			s4_t_iret = 0;
		}
	} else {
		for (s4_t_lp_i = 0; s4_t_lp_i < 2; s4_t_lp_i++) {
			as4_a_bin_music[s4_t_lp_i] = as4_t_bin_music[s4_t_lp_i];
			afl_a_power_music[s4_t_lp_i] = afl_t_power_music[s4_t_lp_i];
			s4_t_iret = s4_t_peak_num;
		}
	}

	return (s4_t_iret);
}

/****************************************************************************/
/* 関数名		: s4_search_peak_music_within_doa_range						*/
/*--------------------------------------------------------------------------*/
/* 機能			: 角度スペクトラムのピークサーチ							*/
/*--------------------------------------------------------------------------*/
/* 引数			: afl_a_music_spec[]		: 角度スペクトラム				*/
/*				: ps4_a_bin_music			: 角度ピークbin					*/
/*				: pfl_a_power_music			: 角度ピーク電力				*/
/*				: s4_a_wave_num				: 到来波数						*/
/*				: s4_a_start_doa			: ピーク探索開始bin				*/
/*				: s4_a_end_doa				: ピーク探索終了bin				*/
/* 戻り値		: s4_t_peak_num				: ピーク数(値域は0〜2)			*/
/*--------------------------------------------------------------------------*/
/* グローバル変数アクセス													*/
/* <input>		: なし														*/
/* <output>		: なし														*/
/*--------------------------------------------------------------------------*/
/* 参照関数 	: なし														*/
/*--------------------------------------------------------------------------*/
/* 対応仕様   	: MWR-RECO-24G-BSM-RECOG-02-017 (3)方向推定処理				*/
/*				: 3)MUSIC 角度スペクトラムのピークサーチ					*/
/*				: (ii)角度スペクトラムのピークサーチ						*/
/*--------------------------------------------------------------------------*/
/* 注意事項		: 本関数に対応する仕様を、納入先検査が参照している。		*/
/* 				: 本関数の変更時には、参照元関数も併せて変更すること。		*/
/* 参照元		: s4_fact_cmn_search_peak_music()							*/
/****************************************************************************/
S4 s4_search_peak_music_within_doa_range(
	const FL afl_a_music_spec[N_DOA],	/*  [in] spectrum power */
	S4 *ps4_a_bin_music,				/*  [out] DOA of MUSIC peak */
	FL *pfl_a_power_music,				/*  [out] power of MUSIC peak */
	S4 s4_a_wave_num,					/*  [in] number of waves */
	S4 s4_a_start_doa,					/*  [in] start bin of the scope of doa */
	S4 s4_a_end_doa						/*  [in] end bin of the scope of doa */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_k;

	S4 as4_t_bin_music[4];
	FL afl_t_power_music[4];
	S4 as4_t_tmp_bin_music[4];
	FL afl_t_tmp_power_music[4];
	S4 s4_t_peak_num = 0;
	S4 s4_t_int;
	FL s4_t_float;
	S4 s4_t_begin = -1;
	U1 u1_t_lp_peak_num;

	/* ローカル変数初期化 */
	for (u1_t_lp_peak_num = (U1)0; u1_t_lp_peak_num < (U1)4; u1_t_lp_peak_num++) {
		as4_t_bin_music[u1_t_lp_peak_num] = (S4)0;
		afl_t_power_music[u1_t_lp_peak_num] = (FL)0.0F;
		as4_t_tmp_bin_music[u1_t_lp_peak_num] = (S4)0;
		afl_t_tmp_power_music[u1_t_lp_peak_num] = (FL)0.0F;
	}

	for (s4_t_lp_i = s4_a_start_doa; s4_t_lp_i < (s4_a_end_doa - (S4)1); s4_t_lp_i++) {
		if(s4_t_peak_num < 4)
		{
			if ((afl_a_music_spec[s4_t_lp_i] < afl_a_music_spec[s4_t_lp_i+1])
			&&  (afl_a_music_spec[s4_t_lp_i+1] > DOA_POW_THRESHOLD_MUSIC)) {
				s4_t_begin = s4_t_lp_i;
			}
			if( s4_t_begin != -1 )
			{
				if ((afl_a_music_spec[s4_t_lp_i] > afl_a_music_spec[s4_t_lp_i+1])
				&&  (afl_a_music_spec[s4_t_lp_i] > DOA_POW_THRESHOLD_MUSIC)) {
					as4_t_bin_music[s4_t_peak_num] = (S4)((FL)(s4_t_begin+s4_t_lp_i+(S4)1)*0.5F);
					afl_t_power_music[s4_t_peak_num] = afl_a_music_spec[as4_t_bin_music[s4_t_peak_num]];
					s4_t_peak_num++;
					s4_t_begin = -1;
				}
			}
		}
	}
	/* 探索範囲の終端を確認 */
	/*	       PEAK			*/
	/*          x			*/
	/*	 x					*/
	/*[end-2] [end-1]		*/
	if( s4_t_peak_num < s4_a_wave_num )
	{
		if(	afl_a_music_spec[s4_a_end_doa-2] < afl_a_music_spec[s4_a_end_doa-1] )
		{
			if(afl_a_music_spec[s4_a_end_doa-1] > DOA_POW_THRESHOLD_MUSIC)
			{
				as4_t_bin_music[s4_t_peak_num] = s4_a_end_doa-(S4)1;
				afl_t_power_music[s4_t_peak_num] = afl_a_music_spec[s4_a_end_doa-1];
				s4_t_peak_num++;
			}
		}
	}

	/***********ピーク電力順にならべかえ*****************/
	for ( s4_t_lp_i=0; s4_t_lp_i<s4_t_peak_num; s4_t_lp_i++ )
	{
		for ( s4_t_lp_k = s4_t_lp_i+1; s4_t_lp_k < s4_t_peak_num; s4_t_lp_k++ )
		{
			if ( afl_t_power_music[s4_t_lp_i] < afl_t_power_music[s4_t_lp_k] )
			{
				s4_t_int = as4_t_bin_music[s4_t_lp_i];
				as4_t_bin_music[s4_t_lp_i] = as4_t_bin_music[s4_t_lp_k];
				as4_t_bin_music[s4_t_lp_k] = s4_t_int;

				s4_t_float = afl_t_power_music[s4_t_lp_i];
				afl_t_power_music[s4_t_lp_i] = afl_t_power_music[s4_t_lp_k];
				afl_t_power_music[s4_t_lp_k] = s4_t_float;
			}
		}
	}
	if( s4_t_peak_num > s4_a_wave_num )
	{
		s4_t_peak_num = s4_a_wave_num;
	}
	for ( s4_t_lp_i=0; s4_t_lp_i<s4_t_peak_num; s4_t_lp_i++ )
	{
		as4_t_tmp_bin_music[s4_t_lp_i] = as4_t_bin_music[s4_t_lp_i];
		afl_t_tmp_power_music[s4_t_lp_i] = afl_t_power_music[s4_t_lp_i];
	}

	/***********bin順にならべかえ*****************/
	for ( s4_t_lp_i=0; s4_t_lp_i<s4_t_peak_num; s4_t_lp_i++ )
	{
		for ( s4_t_lp_k = s4_t_lp_i+1; s4_t_lp_k < s4_t_peak_num; s4_t_lp_k++ )
		{
#if (BSM_OPTION_SW_RECOG_02 == TYPE_A)
			if ( as4_t_tmp_bin_music[s4_t_lp_i] > as4_t_tmp_bin_music[s4_t_lp_k] )
#elif (BSM_OPTION_SW_RECOG_02 == TYPE_B)
			if ( afl_t_tmp_power_music[s4_t_lp_i] > afl_t_tmp_power_music[s4_t_lp_k] )
#else
	マクロ未定義の場合は、コンパイルエラーとする
#endif /* BSM_OPTION_SW_RECOG_02 */
			{
				s4_t_int = as4_t_tmp_bin_music[s4_t_lp_i];
				as4_t_tmp_bin_music[s4_t_lp_i] = as4_t_tmp_bin_music[s4_t_lp_k];
				as4_t_tmp_bin_music[s4_t_lp_k] = s4_t_int;

				s4_t_float = afl_t_tmp_power_music[s4_t_lp_i];
				afl_t_tmp_power_music[s4_t_lp_i] = afl_t_tmp_power_music[s4_t_lp_k];
				afl_t_tmp_power_music[s4_t_lp_k] = s4_t_float;
			}
		}
	}

	for ( s4_t_lp_i=0; s4_t_lp_i<s4_a_wave_num; s4_t_lp_i++ )
	{
		ps4_a_bin_music[s4_t_lp_i] = as4_t_tmp_bin_music[s4_t_lp_i];
		pfl_a_power_music[s4_t_lp_i] = afl_t_tmp_power_music[s4_t_lp_i];
	}

	return s4_t_peak_num;
}

/****************************************************************************/
/* 関数名		: fl_interpolate_music_peak									*/
/*--------------------------------------------------------------------------*/
/* 機能			: 角度ピーク補間											*/
/*--------------------------------------------------------------------------*/
/* 引数			: afl_a_music_spec[]			: 角度スペクトラム電力[in]	*/
/*				  s4_a_peak_doa					: 角度ピークbin[in]			*/
/*				  afl_a_yomikae_table[]			: 読み替えテーブル[in]		*/
/* 戻り値		: fl_t_doa						: 角度ピーク補間結果		*/
/*--------------------------------------------------------------------------*/
/* グローバル変数アクセス													*/
/* <input>		: なし														*/
/* <output>		: なし														*/
/*--------------------------------------------------------------------------*/
/* 参照関数 	: なし														*/
/*--------------------------------------------------------------------------*/
/* 作成者   	: 															*/
/*--------------------------------------------------------------------------*/
/* 注意事項		: 本関数に対応する仕様を、納入先検査が参照している。		*/
/* 				: 本関数の変更時には、参照元関数も併せて変更すること。		*/
/* 参照元		: fl_fact_cmn_intpl_music_peak()							*/
/****************************************************************************/
FL fl_interpolate_music_peak(const FL afl_a_music_spec[N_DOA],
							 S4 s4_a_peak_doa,
							 const FL afl_a_yomikae_table[YOMIKAE_TABLE_SIZE])
{
	FL fl_t_doa = 0.0F;					/* 仕様書ではpeak_bin_##_intpl[X] ##はUP/DNが入る */
	FL afl_t_bin[3];					/* 仕様書ではbin[] */
	FL afl_t_pow[3];					/* 仕様書ではpow[] */
	FL afl_t_pow_diff[2];				/* 仕様書ではpow_diff[] */

	/* ローカル変数初期化 */
	afl_t_bin[0] = (FL)0.0F;
	afl_t_bin[1] = (FL)0.0F;
	afl_t_bin[2] = (FL)0.0F;
	afl_t_pow[0] = (FL)0.0F;
	afl_t_pow[1] = (FL)0.0F;
	afl_t_pow[2] = (FL)0.0F;
	afl_t_pow_diff[0] = (FL)0.0F;
	afl_t_pow_diff[1] = (FL)0.0F;

	
	if ((s4_a_peak_doa < (S4)1)
	||	(s4_a_peak_doa > (N_DOA - (S4)2))) {
		fl_t_doa = (FL)s4_a_peak_doa;
	} else {
		afl_t_bin[0] = (FL)(s4_a_peak_doa - (S4)1) * (FL)DOA_ANG_PER_BIN;
		afl_t_bin[1] = (FL)(s4_a_peak_doa)         * (FL)DOA_ANG_PER_BIN;
		afl_t_bin[2] = (FL)(s4_a_peak_doa + (S4)1) * (FL)DOA_ANG_PER_BIN;
		afl_t_pow[0] = afl_a_music_spec[s4_a_peak_doa - 1];
		afl_t_pow[1] = afl_a_music_spec[s4_a_peak_doa];
		afl_t_pow[2] = afl_a_music_spec[s4_a_peak_doa + 1];
		afl_t_pow_diff[0] = afl_t_pow[0] - afl_t_pow[1];
		afl_t_pow_diff[1] = afl_t_pow[1] - afl_t_pow[2];

		if ((afl_t_pow_diff[0] + afl_t_pow_diff[1]) == (FL)0.0F) {
			fl_t_doa = afl_t_bin[1];
		} else if ((afl_t_pow[0] > afl_t_pow[1])
			   &&  (afl_t_pow[1] > afl_t_pow[2])) {
			fl_t_doa = afl_t_bin[0];
		} else if ((afl_t_pow[2] > afl_t_pow[1])
			   &&  (afl_t_pow[1] > afl_t_pow[0])) {
			fl_t_doa = afl_t_bin[2];
		} else {
			/* Y = a(X-b)^2 + c */
			/* X: bin */
			/* Y: pow */
			/* doa = b */
			/* 0割チェックにおける補足事項：																		*/
			/* (afl_t_pow_diff[0] - afl_t_pow_diff[1]) = 0となるのは、pow[0]、pow[1]、pow[2]が一直線に並ぶ時のみ。	*/
			/* ピーク補間実施フラグ = OFFの条件にて、(afl_t_pow_diff[0] - afl_t_pow_diff[1]) = 0 が成立するため、	*/
			/* この条件下では、(afl_t_pow_diff[0] - afl_t_pow_diff[1]) = 0になることはありえない。					*/
			/* そのため、(afl_t_pow_diff[0] - afl_t_pow_diff[1]) = 0のガード処理は不要。							*/
			fl_t_doa = (afl_t_pow_diff[1] * ((afl_t_bin[0] * afl_t_bin[0]) - (afl_t_bin[1] * afl_t_bin[1]))
					 -  afl_t_pow_diff[0] * ((afl_t_bin[1] * afl_t_bin[1]) - (afl_t_bin[2] * afl_t_bin[2])))
					 / ((FL)2.0F * (FL)DOA_ANG_PER_BIN * (afl_t_pow_diff[0] - afl_t_pow_diff[1]));
		}

		/* 線形補間により読み替え値を算出する（方位読替テーブルは3deg刻みのため）case.2 */
		fl_t_doa =  afl_a_yomikae_table[(S4)(fl_t_doa / (FL)3.0F)]
				 + (afl_a_yomikae_table[(S4)(fl_t_doa / (FL)3.0F) + 1] - afl_a_yomikae_table[(S4)(fl_t_doa / (FL)3.0F)])
				 / (FL)3.0F * (fl_t_doa - (S4)(fl_t_doa / (FL)3.0F) * (FL)3.0F);			/* proc.1 */

		/* 方位読み替え結果を0と(N_DOA - 1.0)で上下限ガード */
		if (fl_t_doa > ((FL)N_DOA - (FL)1.0F)) {
			fl_t_doa = (FL)N_DOA - (FL)1.0F;
		} else if (fl_t_doa < (FL)0.0F) {
			fl_t_doa = (FL)0.0F;
		} else {
			/* 値保持のため何もしない */
		}
	}
	
	return fl_t_doa;
}

/* peak search for beamforming result */
/* @return :number of peaks ( MAX:1 ) */
/* @param :see below */
S4 s4_search_peak_bf(
	const FL afl_a_spec[N_DOA],				/*  [in] spectrum power */
	S4 as4_a_peak_bin[WAVE_NUMBER_MAX],		/*  [out] peak bin */
	FL afl_a_peak_power[WAVE_NUMBER_MAX],	/*  [out] peak power */
	S4 s4_a_wave_num						/*  [in/out] number of waves */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_peak_bin_num = 0;
	FL fl_t_peak_power = 0.0F;
	S4 s4_t_peak_num = 0;
	FL fl_t_power_sum = 0.0F;
	S4 s4_t_begin = -1;
	S4 s4_t_point_num = 0;

	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		if(s4_t_begin == -1)												/* cond.f1 */
		{
			if(afl_a_spec[s4_t_lp_i] > fl_t_peak_power)						/* cond.f2 */
			{
				fl_t_power_sum = afl_a_spec[s4_t_lp_i];						/* proc.1 */
				s4_t_point_num = 1;											/* proc.2 */
				s4_t_begin = s4_t_lp_i;										/* proc.3 */
				s4_t_peak_bin_num = s4_t_lp_i;								/* proc.4 */
				fl_t_peak_power = fl_t_power_sum / (FL)s4_t_point_num;		/* proc.5 */
			}
		}
		else
		{
			if(afl_a_spec[s4_t_lp_i] > (fl_t_peak_power + (FL)0.05F))		/* cond.f3 */
			{
				fl_t_power_sum = afl_a_spec[s4_t_lp_i];						/* proc.1 */
				s4_t_point_num = 1;											/* proc.2 */
				s4_t_begin = s4_t_lp_i;										/* proc.3 */
				s4_t_peak_bin_num = (S4)((FL)(s4_t_begin+s4_t_lp_i+(S4)1)*0.5F);	/* proc.6 */
				fl_t_peak_power = fl_t_power_sum / (FL)s4_t_point_num;			/* proc.5 */
			}
			else if(afl_a_spec[s4_t_lp_i] < fl_t_peak_power)				/* cond.f4 */
			{
				s4_t_peak_bin_num = (S4)((FL)(s4_t_begin+s4_t_lp_i)*0.5F);		/* proc.6 */
				fl_t_peak_power = fl_t_power_sum / (FL)s4_t_point_num;			/* proc.5 */
				s4_t_begin = -1;											/* proc.7 */
				fl_t_power_sum = 0.0F;										/* proc.8 */
				s4_t_point_num = 0;											/* proc.9 */
			}
			else
			{
				fl_t_power_sum += afl_a_spec[s4_t_lp_i];					/* proc.10 */
				s4_t_point_num++;											/* proc.11 */
			}
		}
	}

	if (fl_t_peak_power != 0.0F) {
		as4_a_peak_bin[0] = s4_t_peak_bin_num;
		afl_a_peak_power[0] = fl_t_peak_power;
		s4_t_peak_num = 1;

	}

	return (s4_t_peak_num);
}

/****************************************************************************/
/* 関数名		: s4_calc_eigen_vector_4ch									*/
/*--------------------------------------------------------------------------*/
/* 機能			: MUSICによる角度スペクトラムの算出							*/
/*--------------------------------------------------------------------------*/
/* 引数			: afl_a_Ryy[]				: 自己相関行列					*/
/*				: afl_a_W[][]				: 固有ベクトル					*/
/* 戻り値		: s4_t_iRet					: 到来波数(値域は1〜3)			*/
/*--------------------------------------------------------------------------*/
/* グローバル変数アクセス													*/
/* <input>		: なし														*/
/* <output>		: なし														*/
/*--------------------------------------------------------------------------*/
/* 参照関数 	: fn_cmn_qr_cal_4ch, fl_abs									*/
/*--------------------------------------------------------------------------*/
/* 対応仕様   	: MWR-RECO-24G-BSM-RECOG-02-017 (3)方向推定処理				*/
/*				: 2)MUSICによる角度スペクトラムの算出						*/
/*--------------------------------------------------------------------------*/
/* 注意事項		: 本関数に対応する仕様を、納入先検査が参照している。		*/
/* 				: 本関数の変更時には、参照元関数も併せて変更すること。		*/
/* 参照元		: s4_fact_calc_eigen_vector_4ch()							*/
/****************************************************************************/
S4 s4_calc_eigen_vector_4ch(			/* $$$ 2013.07.09 到来波数推定 */
	const FL afl_a_Ryy[CORRE_SIZE_4CH],	/*  [in] */
	FL afl_a_W[4][4]					/*  [out] */
)
{
	S4 s4_t_iRet = 1;	/* $$$ 2013.07.09 到来波数推定 */
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;

	FL afl_t_lamda[4];
	FL afl_t_Ryy[4][4];
	FL fl_t_ave_power;

	for (s4_t_lp_i = 0; s4_t_lp_i < 4; s4_t_lp_i++) {
		afl_t_lamda[s4_t_lp_i] = 0.0F;
	}
	/****************相関行列********************/
	afl_t_Ryy[0][0] = afl_a_Ryy[0];
	afl_t_Ryy[0][1] = afl_a_Ryy[1];
	afl_t_Ryy[0][2] = afl_a_Ryy[3];
	afl_t_Ryy[0][3] = afl_a_Ryy[6];

	afl_t_Ryy[1][0] = afl_a_Ryy[1];
	afl_t_Ryy[1][1] = afl_a_Ryy[2];
	afl_t_Ryy[1][2] = afl_a_Ryy[4];
	afl_t_Ryy[1][3] = afl_a_Ryy[7];

	afl_t_Ryy[2][0] = afl_a_Ryy[3];
	afl_t_Ryy[2][1] = afl_a_Ryy[4];
	afl_t_Ryy[2][2] = afl_a_Ryy[5];
	afl_t_Ryy[2][3] = afl_a_Ryy[8];

	afl_t_Ryy[3][0] = afl_a_Ryy[6];
	afl_t_Ryy[3][1] = afl_a_Ryy[7];
	afl_t_Ryy[3][2] = afl_a_Ryy[8];
	afl_t_Ryy[3][3] = afl_a_Ryy[9];

	/*********** 平均パワーにより相関行列のスケーリング *****************/
	fl_t_ave_power = 0.0;
	for (s4_t_lp_i = 0; s4_t_lp_i < 4; s4_t_lp_i++) {
		fl_t_ave_power += afl_t_Ryy[s4_t_lp_i][s4_t_lp_i];
	}
	fl_t_ave_power = fl_t_ave_power / (FL)4;

	if (fl_t_ave_power != (FL)0.0F) {														/* 0割ガード そのため「!=」を使用する */
		for (s4_t_lp_i = 0; s4_t_lp_i < 4; s4_t_lp_i++ ) {
			for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++ ) {
				afl_t_Ryy[s4_t_lp_i][s4_t_lp_j] = afl_t_Ryy[s4_t_lp_i][s4_t_lp_j] / fl_t_ave_power;
			}
		}
	} else {
		for (s4_t_lp_i = (S4)0; s4_t_lp_i < (S4)4; s4_t_lp_i++ ) {
			for (s4_t_lp_j = (S4)0; s4_t_lp_j < (S4)4; s4_t_lp_j++ ) {
				/* 0割となる場合は単位行列を入れる 仕様確認No.1600 */
				if (s4_t_lp_i == s4_t_lp_j) {
					afl_t_Ryy[s4_t_lp_i][s4_t_lp_j] = (FL)1.0F;
				} else {
					afl_t_Ryy[s4_t_lp_i][s4_t_lp_j] = (FL)0.0F;
				}
			}
		}
	}

	/***********ＱＲ分解による固有値展開*****************/
	fn_cmn_qr_cal_4ch(
		afl_t_Ryy,		/*  [in] */
		afl_t_lamda,	/*  [out] */
		afl_a_W			/*  [out] */
	);

	for (s4_t_lp_i = 0; s4_t_lp_i < 4; s4_t_lp_i++) {
		afl_t_lamda[s4_t_lp_i] = 10.0F * (FL)fl_log10(afl_t_lamda[s4_t_lp_i] * fl_t_ave_power);
	}

#if (BSM_OPTION_SW_RECOG_02 == TYPE_A)
	/* $$$ 2013.07.09 到来波数推定 */
	if (fl_abs(afl_t_lamda[0] - afl_t_lamda[1]) < fl_abs(afl_t_lamda[1] - afl_t_lamda[3])) {
		s4_t_iRet = 2;
	}
#elif (BSM_OPTION_SW_RECOG_02 == TYPE_B)
	/* Condition of Wave number = 2 */
	if ((fl_abs(afl_t_lamda[0]) > fl_abs(afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[1]) > fl_abs(afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[0] - afl_t_lamda[1]) < fl_abs(afl_t_lamda[1] - afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[1] - afl_t_lamda[2]) > fl_abs(afl_t_lamda[0] - afl_t_lamda[1]))) {
	    s4_t_iRet = (S4)2;
	}

	/* Condition of Wave number = 3  */
	if ((fl_abs(afl_t_lamda[0]) > fl_abs(afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[1]) > fl_abs(afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[2]) > fl_abs(afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[0] - afl_t_lamda[1]) < fl_abs(afl_t_lamda[1] - afl_t_lamda[3]))
	&&  (fl_abs(afl_t_lamda[1] - afl_t_lamda[2]) < fl_abs(afl_t_lamda[0] - afl_t_lamda[1]))) {
	    s4_t_iRet = (S4)3;
	}
#else
	マクロ未定義の場合は、コンパイルエラーとする
#endif /* BSM_OPTION_SW_RECOG_02 */

	return (s4_t_iRet);
}


VD fn_check_existing_peak_and_doa_info_fm(					/* [return] 0, 1, 2 */
	S4 s4_a_focus_bin,										/* [in] focus bin */
	S4 *ps4_a_doa_num,
	S4 as4_t_selected_doa_bins[2],
	FL afl_t_selected_doa_powers[2],
	const S4 as4_a_finished_doa_bin_fm[COMMON_PEAKBUFF_SIZE_FM][2],	/* [in] */
	const FL afl_a_finished_doa_power_fm[COMMON_PEAKBUFF_SIZE_FM][2]	/* [in] */
)
{
	S4 s4_t_lp_i;

	*ps4_a_doa_num = 0;
	if ((s4_a_focus_bin >= FREQ_BIN_LOWER_LIMIT) && (s4_a_focus_bin < (FREQ_BIN_UPPER_LIMIT + 1))) {	/* _20130113_3 [0]〜[NB_FFT_PT-1]から変更 */
		for (s4_t_lp_i = 0; s4_t_lp_i < 2; s4_t_lp_i++) {
			if (as4_a_finished_doa_bin_fm[s4_a_focus_bin - FREQ_BIN_LOWER_LIMIT][s4_t_lp_i] != -1.0F) {		/* _20130113_3 [s4_a_focus_bin]から変更 */

				as4_t_selected_doa_bins[s4_t_lp_i]   = as4_a_finished_doa_bin_fm[s4_a_focus_bin - FREQ_BIN_LOWER_LIMIT][s4_t_lp_i];		/* DOA peak bin */
				afl_t_selected_doa_powers[s4_t_lp_i] = afl_a_finished_doa_power_fm[s4_a_focus_bin - FREQ_BIN_LOWER_LIMIT][s4_t_lp_i];	/* afl_a_power of DOA peak */

				(*ps4_a_doa_num)++;
			}
		}
	}

	return;
}

S4 s4_search_freq_peak(
	const FL afl_a_power[NB_FFT_PT],			/* [in] raw data */
	S4 as4_a_peak_bin[PEAK_BUFFSIZE],			/* [in / out] frequency of peak */
	FL afl_a_peak_bin_intpl[PEAK_BUFFSIZE],		/* [out] frequency of peak */
	FL afl_a_peak_power[PEAK_BUFFSIZE],			/* [out] afl_a_power of peak */
	const FL afl_a_thres[NB_FFT_PT],			/* [in] threshold */
	S4 s4_a_start_bin,							/* [in] start bin of the scope of frequency */
	S4 s4_a_end_bin								/* [in] end bin of the scope of frequency */
)
{
	S4 s4_t_i;
	S4 s4_t_peak_num = 0;
	s4_t_peak_num = s4_search_freq_peaks_within_freq_range(
		(const FL *)afl_a_power,
		as4_a_peak_bin,
		afl_a_peak_power,
		(const FL *)afl_a_thres,
		0,
		s4_a_start_bin,
		s4_a_end_bin
	);
	for(s4_t_i=0; s4_t_i<s4_t_peak_num; s4_t_i++)
	{
		afl_a_peak_bin_intpl[s4_t_i] = fl_interpolate_freq_peak(
			(const FL *)afl_a_power,
			as4_a_peak_bin[s4_t_i]
		);
	}
	return s4_t_peak_num;
}

/* search peaks within specified frequency range */
/* @return :number of peaks (MAX:NORMAL_BUFFSIZE(= 20)) */
/* @param :see below */
S4 s4_search_freq_peaks_within_freq_range(
	const FL afl_a_power[NB_FFT_PT],			/* [in] raw data */
	S4 as4_a_peak_bin[PEAK_BUFFSIZE],			/* [in / out] frequency of peak */
	FL afl_a_peak_power[PEAK_BUFFSIZE],			/* [out] afl_a_power of peak */
	const FL afl_a_thres[NB_FFT_PT],			/* [in] threshold */
	S4 s4_a_index,								/* [in] start s4_a_index of peak buffer */
	S4 s4_a_start_bin,							/* [in] start bin of the scope of frequency */
	S4 s4_a_end_bin								/* [in] end bin of the scope of frequency */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;

	S4 s4_t_peak_num = 0;

	S4 s4_t_start_bin = 0;
	S4 s4_t_end_bin = 0;
	S4 s4_t_pieak_num_max = PEAK_BUFFSIZE;
	S4 s4_t_buf_peak_num = 0;
	S4 as4_t_peak_bin[NB_FFT_PT];
	FL afl_t_peak_power[NB_FFT_PT];

	for (s4_t_lp_i = 0; s4_t_lp_i < NB_FFT_PT; s4_t_lp_i++) {
		as4_t_peak_bin[s4_t_lp_i] = 0;
		afl_t_peak_power[s4_t_lp_i] = 0.0F;
	}

	s4_t_start_bin = s4_a_start_bin - (S4)1;
	if (s4_t_start_bin < 0) {
		s4_t_start_bin = 0;
	}

	s4_t_end_bin = s4_a_end_bin + (S4)1;
	if (s4_t_end_bin > (S4)(NB_FFT_PT - 2)) {
		s4_t_end_bin = NB_FFT_PT - (S4)2;
	}

	for (s4_t_lp_i = s4_t_start_bin; s4_t_lp_i < s4_t_end_bin; s4_t_lp_i++) {

		/*************************/
		/* 	      PEAK           */
		/* 	       x             */
		/* 	 x             x     */
		/* 	[i] [i + 1] [i + 2]  */
		/*************************/

		if ((afl_a_power[s4_t_lp_i] < afl_a_power[s4_t_lp_i + 1])
		 && (afl_a_power[s4_t_lp_i + 1] > afl_a_power[s4_t_lp_i + 2])
		 && (afl_a_power[s4_t_lp_i + 1] > afl_a_thres[s4_t_lp_i + 1])
		 && (s4_t_buf_peak_num < s4_t_pieak_num_max)
		) {
			as4_t_peak_bin[s4_t_buf_peak_num] = s4_t_lp_i + (S4)1;
			afl_t_peak_power[s4_t_buf_peak_num] = afl_a_power[s4_t_lp_i + 1];
			s4_t_buf_peak_num++;
		}
	}

	for (s4_t_lp_i = 0; s4_t_lp_i < s4_t_buf_peak_num; s4_t_lp_i++) {
		as4_a_peak_bin[s4_t_peak_num] = as4_t_peak_bin[s4_t_lp_i];
		afl_a_peak_power[s4_t_peak_num] = afl_t_peak_power[s4_t_lp_i];
		s4_t_peak_num++;
	}

	return (s4_t_peak_num);
}

FL fl_interpolate_freq_peak(				/* [return] interpolated peak bin */
	const FL power[NB_FFT_PT],				/* [in] spectrum */
	S4 peak_bin
)
{
	FL bin_intpl = 0.0F;
	FL bin[3];
	FL pow[3];
	FL pow_diff[2];

	/* ローカル変数初期化 */
	bin[0] = (FL)0.0F;
	bin[1] = (FL)0.0F;
	bin[2] = (FL)0.0F;
	pow[0] = (FL)0.0F;
	pow[1] = (FL)0.0F;
	pow[2] = (FL)0.0F;
	pow_diff[0] = (FL)0.0F;
	pow_diff[1] = (FL)0.0F;

	if ((peak_bin < (S4)1)
	||  (peak_bin > (NB_FFT_PT - (S4)2))) {
		bin_intpl = (FL)peak_bin;
	} else {
		bin[0] = (FL)(peak_bin-1)*1.0F;
		bin[1] = (FL)(peak_bin)*1.0F;
		bin[2] = (FL)(peak_bin+1)*1.0F;
		pow[0] = power[peak_bin-1];
		pow[1] = power[peak_bin];
		pow[2] = power[peak_bin+1];
		pow_diff[0] = pow[0]-pow[1];
		pow_diff[1] = pow[1]-pow[2];

		if ((pow_diff[0] + pow_diff[1]) == 0) {
			bin_intpl = bin[1];
		} else if ((pow[0] > pow[1])
			   &&  (pow[1] > pow[2])) {
			bin_intpl = bin[0];
		} else if ((pow[2] > pow[1])
			   &&  (pow[1] > pow[0])) {
			bin_intpl = bin[2];
		} else {
			/* Y = a(X-b)^2 + c */
			/* X: bin */
			/* Y: pow */
			/* doa = b */
			bin_intpl = ( pow_diff[1]*(bin[0]*bin[0] - bin[1]*bin[1]) -  pow_diff[0]*(bin[1]*bin[1] - bin[2]*bin[2]) ) / (2.0F*(pow_diff[0] - pow_diff[1]));
		}
		if ((bin_intpl > (FL)(NB_FFT_PT-1)) 
		||  (bin_intpl < (FL)0.0F)) {
			bin_intpl = (FL)peak_bin;
		}
	}

	return bin_intpl;
}

/* set threshold for peak detection */
/* @param :see below */
VD fn_set_freq_threshold(
	const FL afl_a_power[NB_FFT_PT],		/* [in] afl_a_power of beat signal */
	FL afl_a_thres[NB_FFT_PT]				/* [out] threshold for peak detection */
#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161123_BTT_FM_THRES)
	,S4 s4_object_type						/* [in] object type: ordinary or trailer */
#endif
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;
	S4 s4_t_index_near_center = -1;
	S4 s4_t_ave_range = AVE_BIN_WIDTH;
	FL afl_t_ave_power[NB_FFT_PT / AVE_BIN_WIDTH];
	FL fl_t_clearance = AVE_POW_CLEARANCE;
	FL fl_t_max_power_th = PEAK_POW_TH_MAX;
	S4 s4_t_center_bin = (S4)(NB_FFT_PT / 2);
	S4 s4_t_center_range = CENTER_FREQ_RANGE;
	FL fl_t_peak_pow_th_min;
#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161123_BTT_FM_THRES)
	S4 s4_t_target_flag;
#endif
	S4 s4_t_loop_max;
	s4_t_loop_max = NB_FFT_PT / s4_t_ave_range;

	/* 8 freq-bin毎の平均電力 */
	for (s4_t_lp_i = 0; s4_t_lp_i < s4_t_loop_max; s4_t_lp_i++) {
		afl_t_ave_power[s4_t_lp_i] = 0.0;
		for (s4_t_lp_j = 0; s4_t_lp_j < s4_t_ave_range; s4_t_lp_j++) {
			afl_t_ave_power[s4_t_lp_i] = afl_t_ave_power[s4_t_lp_i] + afl_a_power[(s4_t_lp_i * s4_t_ave_range) + s4_t_lp_j];
		}
		afl_t_ave_power[s4_t_lp_i] = afl_t_ave_power[s4_t_lp_i] / (FL)s4_t_ave_range;

		if ((s4_t_lp_i * s4_t_ave_range) > FREQ_BIN_LOWER_LIMIT) {
			fl_t_peak_pow_th_min = (PEAK_POW_TH_MIN_SLOPE * (FL)((s4_t_lp_i * s4_t_ave_range) - FREQ_BIN_LOWER_LIMIT)) + PEAK_POW_TH_MIN_NEAR;
			if(s4_t_index_near_center == -1)
			{
				s4_t_index_near_center = s4_t_lp_i*s4_t_ave_range;
			}
		}
		else
		{
			fl_t_peak_pow_th_min = PEAK_POW_TH_MAX;
		}

		/* 工程内検査実施中は閾値を-1000.0としスロープ状の閾値を無効化する */
		if (u1_ecu_chk_exe_stt() == CU1_CHK_EXE) {
			fl_t_peak_pow_th_min = (FL)-1000.0F;
		}

		if (afl_t_ave_power[s4_t_lp_i] < fl_t_peak_pow_th_min) {
			afl_t_ave_power[s4_t_lp_i] = fl_t_peak_pow_th_min;
		}

		for (s4_t_lp_j = 0; s4_t_lp_j < s4_t_ave_range; s4_t_lp_j++) {
			afl_a_thres[(s4_t_lp_i * s4_t_ave_range) + s4_t_lp_j] = afl_t_ave_power[s4_t_lp_i] + fl_t_clearance;
		}
	}

#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161123_BTT_FM_THRES)
	/* change the power threshold for trailer object */
	if( s4_object_type == OBJECT_TYPE_TRAILER) {
		/* check if there is target at the nearside of SV */
		s4_t_target_flag = (S4)0;
		for(s4_t_lp_i = 0; s4_t_lp_i < st_g_bsm_loop_data.as4_buf_pair_num[0]; s4_t_lp_i++)
		{
			if( (fl_abs(st_g_bsm_loop_data.ast_normal[s4_t_lp_i].fl_Rxfil) < NEAR_TGT_SIDE_TH)	/* [m] */
			 && (st_g_bsm_loop_data.ast_normal[s4_t_lp_i].fl_Ryfil > NEAR_TGT_BACK_TH)			/* [m] */
			 && (st_g_bsm_loop_data.ast_normal[s4_t_lp_i].fl_Ryfil < NEAR_TGT_FRONT_TH)			/* [m] */
			){
				s4_t_target_flag = (S4)1;
				break;
			}
		}

		if( s4_t_target_flag == (S4)1 )
		{
			/* set higher threshold when there is other target at the nearside of SV */
			for(s4_t_lp_i = FREQ_BIN_LOWER_LIMIT_T; s4_t_lp_i < FREQ_BIN_UPPER_LIMIT_DN_T+1; s4_t_lp_i++)
			{
#ifndef _20170217_BTT_ATD_POW_TH
				if( s4_t_lp_i < s4_t_index_near_center ){
					afl_a_thres[s4_t_lp_i] = PEAK_POW_TH_AROUND_CENTER + BTT_POW_TH_OFFSET;		/* [dB] */
				}
#else
				afl_a_thres[s4_t_lp_i] = PEAK_POW_TH_AROUND_CENTER + BTT_POW_TH_OFFSET;			/* [dB] */
#endif
#ifndef _20170117_BTT_ATD_CURV_POWTH
				/* decrease threshold if curvature < -10 */
				if( s4_abs(s2_g_curvr_for_base) < (S2)CU1_CANOUT_CURVER_MIN_SOT 
				 && s2_g_curvr_for_base < (S2)0
				){
#ifndef _20170220_BTT_TRAILEROBJ
					afl_a_thres[s4_t_lp_i] -= BTT_POW_TH_OFFSET2;
#else
					afl_a_thres[s4_t_lp_i] -= BTT_POW_TH_OFFSET;
#endif
				}
#endif
			}
		} else {
			for(s4_t_lp_i = FREQ_BIN_LOWER_LIMIT_T; s4_t_lp_i < FREQ_BIN_UPPER_LIMIT_DN_T+1; s4_t_lp_i++)
			{
#ifndef _20170217_BTT_ATD_POW_TH
				if( s4_t_lp_i < s4_t_index_near_center ){
					afl_a_thres[s4_t_lp_i] = PEAK_POW_TH_AROUND_CENTER;		/* [dB] */
				}
#else
				afl_a_thres[s4_t_lp_i] = PEAK_POW_TH_AROUND_CENTER;				/* [dB] */
#endif
#ifndef _20170117_BTT_ATD_CURV_POWTH
				/* decrease threshold if curvature < -10 */
				if( s4_abs(s2_g_curvr_for_base) < (S2)CU1_CANOUT_CURVER_MIN_SOT 
				 && s2_g_curvr_for_base < (S2)0
				){
#ifndef _20170220_BTT_TRAILEROBJ
					afl_a_thres[s4_t_lp_i] -= BTT_POW_TH_OFFSET2;
#else
					afl_a_thres[s4_t_lp_i] -= BTT_POW_TH_OFFSET;
#endif
				}
#endif
			}
		}
	} else{
#endif
		/* 中心付近の閾値を高くする */
		for (s4_t_lp_i = (s4_t_center_bin - s4_t_center_range); s4_t_lp_i < (s4_t_center_bin + s4_t_center_range + 1); s4_t_lp_i++) {
			afl_a_thres[s4_t_lp_i] = fl_t_max_power_th;
		}

		for( s4_t_lp_i = FREQ_BIN_LOWER_LIMIT-1; s4_t_lp_i < s4_t_index_near_center; s4_t_lp_i++)
		{
			/* branch for SoT situation */
			if(st_g_bsm_loop_data.as4_slow_sot_find[0]==0)
			{
				afl_a_thres[s4_t_lp_i] = PEAK_POW_TH_AROUND_CENTER;
			}
			else
			{
				afl_a_thres[s4_t_lp_i] = PEAK_POW_TH_AROUND_CENTER-1.0F;
			}
		}
#if !defined(_291B_DEV_20161005_BTT_TEST) && !defined(_20161123_BTT_FM_THRES)
	}
#endif

	return;

}

/**************************************************************************************************/
/* ↓↓↓↓↓↓↓      シミュレーター用コード ECU時はコンパイル対象外             ↓↓↓↓↓↓↓  */
/**************************************************************************************************/
#if (MODE_ECU_SIM == SIM_MODE)
/**
 * ＭＵＳＩＣスペクトラム算出
 */
VD fn_matrix_spec_4ch(
	FL afl_a_E[4][4],				/*  [in] */
	FL afl_a_spec[N_DOA],			/*  [out] */
	S4 s4_a_wave_num,				/*  [in] */
	S4 s4_a_updn_flg,				/*  [in] */
/* 	FL fl_a_installed_angle			_20140108_1 */
	S4 s4_a_start_bin,				/* _20140113_4 */
	S4 s4_a_end_bin				/* _20140113_4 */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;
	S4 s4_t_lp_k;
	
	FL afl_t_modeEN[4];
	FL afl_t_mode_vec[4];
	FL fl_t_spec_max;

	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		afl_a_spec[s4_t_lp_i] = 0.0F;
	}

	/*********** 角度binごとの電力を計算 *****************/
	/* 	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) */
	/* 	for (s4_t_lp_i=DOA_BIN_LOWER_LIMIT; s4_t_lp_i<DOA_BIN_UPPER_LIMIT; s4_t_lp_i++ )	$$$ 2013.04 Miki */
	/* 	for (s4_t_lp_i=(S4)(N_DOA*0.5F-fl_a_installed_angle-DOA_BIN_LOWER_LIMIT); s4_t_lp_i<(S4)(N_DOA*0.5F-fl_a_installed_angle-DOA_BIN_LOWER_LIMIT+DOA_BIN_UPPER_LIMIT); s4_t_lp_i++ )	_20140108_1 */
	for (s4_t_lp_i = s4_a_start_bin; s4_t_lp_i < s4_a_end_bin; s4_t_lp_i++ ) {		/* _20140113_4 */

		/***********モードベクトル*****************/
		if (s4_a_updn_flg == 1 ) {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] = -CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] = -CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		} else {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] =  CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] =  CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		}

		/************* 雑音空間からスペクトル算出 *********/
		for (s4_t_lp_k = s4_a_wave_num; s4_t_lp_k < 4; s4_t_lp_k++ ) {
			afl_t_modeEN[s4_t_lp_k - s4_a_wave_num] = 0;
			for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++) {
				afl_t_modeEN[s4_t_lp_k - s4_a_wave_num] += afl_t_mode_vec[s4_t_lp_j] * afl_a_E[s4_t_lp_j][s4_t_lp_k];
			}
		}

		afl_a_spec[s4_t_lp_i] = 0.0;
		for (s4_t_lp_k = 0; s4_t_lp_k < (4 - s4_a_wave_num); s4_t_lp_k++ ) {
			afl_a_spec[s4_t_lp_i] = afl_a_spec[s4_t_lp_i] + (afl_t_modeEN[s4_t_lp_k] * afl_t_modeEN[s4_t_lp_k]);
		}
	}

	fl_t_spec_max = 0.0F;
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		if (fl_t_spec_max < fl_abs(afl_a_spec[s4_t_lp_i]) ) {
			fl_t_spec_max = fl_abs(afl_a_spec[s4_t_lp_i]);
		}
	}

	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		afl_a_spec[s4_t_lp_i] = 10 * (FL)fl_log10( 4.0F / afl_a_spec[s4_t_lp_i] );
	}
}

VD fn_matrix_spec_4ch_all(
	FL afl_a_E[4][4],						/*  [in] */
	FL afl_a_spec[N_DOA],					/*  [out] */
	S4 s4_a_wave_num,						/*  [in] */
	S4 s4_a_updn_flg						/*  [in] */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;
	S4 s4_t_lp_k;

	FL afl_t_modeEN[4];
	FL afl_t_mode_vec[4];
	FL fl_t_spec_max;

	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		afl_a_spec[s4_t_lp_i] = 0.0F;
	}

	/*********** 角度binごとの電力を計算 *****************/
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		/***********モードベクトル*****************/
		if (s4_a_updn_flg == 1 ) {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] = -CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] = -CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		} else {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] =  CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] =  CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		}

		/************* 雑音空間からスペクトル算出 *********/
		for (s4_t_lp_k = s4_a_wave_num; s4_t_lp_k < 4; s4_t_lp_k++ ) {
			afl_t_modeEN[s4_t_lp_k - s4_a_wave_num] = 0;
			for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++) {
				afl_t_modeEN[s4_t_lp_k - s4_a_wave_num] += afl_t_mode_vec[s4_t_lp_j] * afl_a_E[s4_t_lp_j][s4_t_lp_k];
			}
		}

		afl_a_spec[s4_t_lp_i] = 0.0;
		for (s4_t_lp_k = 0; s4_t_lp_k < (4 - s4_a_wave_num); s4_t_lp_k++ ) {
			afl_a_spec[s4_t_lp_i] = afl_a_spec[s4_t_lp_i] + (afl_t_modeEN[s4_t_lp_k] * afl_t_modeEN[s4_t_lp_k]);
		}
	}

	fl_t_spec_max = 0.0F;
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		if (fl_t_spec_max < fl_abs(afl_a_spec[s4_t_lp_i]) ) {
			fl_t_spec_max = fl_abs(afl_a_spec[s4_t_lp_i]);
		}
	}

	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++) {
		afl_a_spec[s4_t_lp_i] = 10 * (FL)fl_log10( 4.0F / afl_a_spec[s4_t_lp_i] );
	}
}

/**
 * ＱＲ分解(LINPACK)
 */
VD fn_qr_cal_pivot(
	FL afl_a_R_0[4][4],		/*  [in] */
	FL afl_a_Lam[4],		/*  [out] */
	FL afl_a_B[4][4]		/*  [out] */
)
{
	FL fl_t_Q[16];
	FL fl_t_R[16];
	FL fl_t_E[4];
	FL fl_t_Qraux[4];
	FL fl_t_Work[4];
	FL fl_t_S[16];	/*固有値分解変数*/
	FL fl_t_Ryy[4][4];
	FL fl_t_R_rat_2dimension4x4[4][4];
	FL fl_t_Q_first[4][4];
	FL fl_t_Q_second[4][4];
	FL fl_t_R_rat_1dimension16[16];
	S4 fl_t_Jpvt[4];
	U1 u1_t_lp_jpvt;
	U1 u1_t_lp_ryy_dime1;
	U1 u1_t_lp_ryy_dime2;
	U1 u1_t_lp_R_data;
	U1 u1_t_lp_E_data;
	U1 u1_t_lp_Q_data_dime1;
	U1 u1_t_lp_Q_data_dime2;

	for (u1_t_lp_jpvt = (U1)0; u1_t_lp_jpvt < (U1)4 ; u1_t_lp_jpvt++) {
		fl_t_Jpvt[u1_t_lp_jpvt] = (FL)0.0F;
	}

	for (u1_t_lp_ryy_dime2 = (U1)0; u1_t_lp_ryy_dime2 < (U1)4; u1_t_lp_ryy_dime2++) {
		for (u1_t_lp_ryy_dime1 = (U1)0 ; u1_t_lp_ryy_dime1 < (U1)4 ; u1_t_lp_ryy_dime1++ ) {
			fl_t_R[u1_t_lp_ryy_dime1 + (4 * u1_t_lp_ryy_dime2)] = afl_a_R_0[u1_t_lp_ryy_dime1][u1_t_lp_ryy_dime2];
		}
	}

	/* １回目 QR 分解実施 */
	MWDSP_QRE_R(4,
				4,
				(FL*)fl_t_Q,		/* 出力行列Q */
				(FL*)fl_t_R,		/* 入力および出力行列R */
				(FL*)fl_t_E,		/* 出力ベクトルE（並べ替え情報） */
				(FL*)fl_t_Qraux,	/* 作業変数Qraux */
				(FL*)fl_t_Work,		/* 作業変数Work */
				(S4*)fl_t_Jpvt,		/* 作業変数Jpvt */
				(FL*)fl_t_S);		/* 作業変数S */

	/* pivotting */
	for (u1_t_lp_R_data= (U1)0; u1_t_lp_R_data < (U1)16; u1_t_lp_R_data++) {
		fl_t_R_rat_1dimension16[u1_t_lp_R_data] = fl_t_R[u1_t_lp_R_data];
	}
	for (u1_t_lp_E_data = (U1)0; u1_t_lp_E_data < (U1)4; u1_t_lp_E_data++) {
		for (u1_t_lp_R_data = (U1)0; u1_t_lp_R_data < (U1)4; u1_t_lp_R_data++) {
			fl_t_R[(((S4)fl_t_E[u1_t_lp_E_data] - 1) * 4) + u1_t_lp_R_data] = fl_t_R_rat_1dimension16[(u1_t_lp_E_data * 4) + u1_t_lp_R_data];
		}
	}

	for (u1_t_lp_Q_data_dime2 = (U1)0; u1_t_lp_Q_data_dime2 < (U1)4; u1_t_lp_Q_data_dime2++) {
		for (u1_t_lp_Q_data_dime1 = (U1)0 ; u1_t_lp_Q_data_dime1 < (U1)4; u1_t_lp_Q_data_dime1++) {
			fl_t_R_rat_2dimension4x4[u1_t_lp_Q_data_dime1][u1_t_lp_Q_data_dime2] = fl_t_R[u1_t_lp_Q_data_dime1 + 4 * u1_t_lp_Q_data_dime2];
			fl_t_Q_first[u1_t_lp_Q_data_dime1][u1_t_lp_Q_data_dime2] = fl_t_Q[u1_t_lp_Q_data_dime1 + (4 * u1_t_lp_Q_data_dime2)];
		}
	}

	fn_matmul_4x4( fl_t_R_rat_2dimension4x4, fl_t_Q_first, fl_t_Ryy);

	for (u1_t_lp_ryy_dime2 = (U1)0; u1_t_lp_ryy_dime2 < (U1)4; u1_t_lp_ryy_dime2++) {
		for (u1_t_lp_ryy_dime1 = (U1)0 ; u1_t_lp_ryy_dime1 < (U1)4; u1_t_lp_ryy_dime1++) {
			fl_t_R[u1_t_lp_ryy_dime1 + (4 * u1_t_lp_ryy_dime2)] = fl_t_Ryy[u1_t_lp_ryy_dime1][u1_t_lp_ryy_dime2];
		}
	}

	for (u1_t_lp_jpvt = (U1)0; u1_t_lp_jpvt < (U1)4; u1_t_lp_jpvt++) {
		fl_t_Jpvt[u1_t_lp_jpvt] = (FL)0.0F;
	}

	/* ２回目 QR 分解実施 */
	MWDSP_QRE_R(4,
				4,
				(FL*)fl_t_Q,		/* 出力行列Q */
				(FL*)fl_t_R,		/* 入力および出力行列R */
				(FL*)fl_t_E,		/* 出力ベクトルE（並べ替え情報） */
				(FL*)fl_t_Qraux,	/* 作業変数Qraux */
				(FL*)fl_t_Work,		/* 作業変数Work */
				(S4*)fl_t_Jpvt,		/* 作業変数fl_t_Jpvt */
				(FL*)fl_t_S);		/* 作業変数S */

	/* pivotting */
	for (u1_t_lp_R_data = (U1)0; u1_t_lp_R_data < (U1)16; u1_t_lp_R_data++) {
		fl_t_R_rat_1dimension16[u1_t_lp_R_data] = fl_t_R[u1_t_lp_R_data];
	}
	for ( u1_t_lp_E_data = (U1)0; u1_t_lp_E_data < (U1)4; u1_t_lp_E_data++) {
		for (u1_t_lp_R_data = (U1)0; u1_t_lp_R_data < (U1)4; u1_t_lp_R_data++) {
			fl_t_R[(((S4)fl_t_E[u1_t_lp_E_data] - 1) * 4) + u1_t_lp_R_data] = fl_t_R_rat_1dimension16[(u1_t_lp_E_data * 4) + u1_t_lp_R_data];
		}
	}

	for (u1_t_lp_Q_data_dime2 = (U1)0; u1_t_lp_Q_data_dime2 < (U1)4; u1_t_lp_Q_data_dime2++) {
		for (u1_t_lp_Q_data_dime1 = (U1)0; u1_t_lp_Q_data_dime1 < (U1)4; u1_t_lp_Q_data_dime1++) {
			fl_t_Q_second[u1_t_lp_Q_data_dime1][u1_t_lp_Q_data_dime2] = fl_t_Q[u1_t_lp_Q_data_dime1 + (4 * u1_t_lp_Q_data_dime2)];
		}
	}

	/**************	固有値ベクトルを抽出する**************/	
	fn_matmul_4x4( fl_t_Q_first, fl_t_Q_second, afl_a_B);

	/**************	固有値を抽出する**************/	
	afl_a_Lam[0] = fl_abs(fl_t_R[0]);
	afl_a_Lam[1] = fl_abs(fl_t_R[5]);
	afl_a_Lam[2] = fl_abs(fl_t_R[10]);
	afl_a_Lam[3] = fl_abs(fl_t_R[15]);

	return;
}

VD fn_calc_spec_bf_4ch(
	FL afl_a_Ryy[CORRE_SIZE_4CH],		/*  [in] correlation matrix */
	FL afl_a_spec_bf[N_DOA],			/*  [out] beam forming spectrum */
	S4 s4_a_updn_flg					/*  [in] direction of beat-signal */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;
	S4 s4_t_lp_k;

	FL afl_t_Ryy[4][4];
	FL afl_t_mode_vec[4];
	FL afl_t_Ryy_mode[4];
	FL fl_t_mode_sum = 4.0F;
	FL fl_t_Ryy_sum;

	/**************** 相関行列 ********************/
	afl_t_Ryy[0][0] = afl_a_Ryy[0];
	afl_t_Ryy[0][1] = afl_a_Ryy[1];
	afl_t_Ryy[0][2] = afl_a_Ryy[3];
	afl_t_Ryy[0][3] = afl_a_Ryy[6];

	afl_t_Ryy[1][0] = afl_a_Ryy[1];
	afl_t_Ryy[1][1] = afl_a_Ryy[2];
	afl_t_Ryy[1][2] = afl_a_Ryy[4];
	afl_t_Ryy[1][3] = afl_a_Ryy[7];

	afl_t_Ryy[2][0] = afl_a_Ryy[3];
	afl_t_Ryy[2][1] = afl_a_Ryy[4];
	afl_t_Ryy[2][2] = afl_a_Ryy[5];
	afl_t_Ryy[2][3] = afl_a_Ryy[8];

	afl_t_Ryy[3][0] = afl_a_Ryy[6];
	afl_t_Ryy[3][1] = afl_a_Ryy[7];
	afl_t_Ryy[3][2] = afl_a_Ryy[8];
	afl_t_Ryy[3][3] = afl_a_Ryy[9];

	/*********** スペクトラム初期化 *****************/
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		afl_a_spec_bf[s4_t_lp_i] = 0.0;
	}

	/*********** conventional beamformer *****************/
	/**
	 * ウエイトベクトル
	 *  W =  a(θ)
	 * 出力電圧
	 *       1
	 *  P = --- * a(θ)' * R * a(θ)
	 *       2 
	 * 角度スペクトラム（正規化出力電圧）
	 *                   P               a(θ)' * R * a(θ)
	 *  SP(θ) = -------------------- = --------------------
	 *            a'(θ) * a(θ) / 2       a'(θ) * a(θ)
	 */

	/*********** 角度binごとの電力を計算 *****************/
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		/***********モードベクトル*****************/
		if (s4_a_updn_flg == 1 ) {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] = -CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] = -CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		} else {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] =  CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] =  CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		}

		/* [afl_t_Ryy_mode] = [A] = Kx1 = 4x1 */
		/* fl_t_mode_sum = 0; */
		/* for (s4_t_lp_j=0; s4_t_lp_j<4; s4_t_lp_j++) */
		/* { */
		/* 	fl_t_mode_sum += afl_t_mode_vec[s4_t_lp_j]*afl_t_mode_vec[s4_t_lp_j]; */
		/* }	@@@ fl_t_mode_sum = 4でよい */
		fl_t_Ryy_sum = 0.0F;
		for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++ ) {
			afl_t_Ryy_mode[s4_t_lp_j] = 0.0F;
			for (s4_t_lp_k = 0; s4_t_lp_k < 4; s4_t_lp_k++ ) {
				afl_t_Ryy_mode[s4_t_lp_j] += afl_t_Ryy[s4_t_lp_j][s4_t_lp_k] * afl_t_mode_vec[s4_t_lp_k];
			}
			fl_t_Ryy_sum += afl_t_mode_vec[s4_t_lp_j] * afl_t_Ryy_mode[s4_t_lp_j];
		}
		afl_a_spec_bf[s4_t_lp_i] = 10 * (FL)fl_log10( (0.25F * fl_t_Ryy_sum) / fl_t_mode_sum );		/* $$$ 2013.08.23-6 1/4し忘れバグ */
	}
	return;
}

VD fn_calc_spec_bf_4ch_before_log10(
	FL afl_a_Ryy[CORRE_SIZE_4CH],		/*  [in] correlation matrix */
	FL afl_a_spec_bf[N_DOA],			/*  [out] beam forming spectrum */
	S4 s4_a_updn_flg					/*  [in] direction of beat-signal */
)
{
	S4 s4_t_lp_i;
	S4 s4_t_lp_j;
	S4 s4_t_lp_k;

	FL afl_t_Ryy[4][4];
	FL afl_t_mode_vec[4];
	FL afl_t_Ryy_mode[4];
	FL fl_t_mode_sum = 4.0F;
	FL fl_t_Ryy_sum;

	/**************** 相関行列 ********************/
	afl_t_Ryy[0][0] = afl_a_Ryy[0];
	afl_t_Ryy[0][1] = afl_a_Ryy[1];
	afl_t_Ryy[0][2] = afl_a_Ryy[3];
	afl_t_Ryy[0][3] = afl_a_Ryy[6];

	afl_t_Ryy[1][0] = afl_a_Ryy[1];
	afl_t_Ryy[1][1] = afl_a_Ryy[2];
	afl_t_Ryy[1][2] = afl_a_Ryy[4];
	afl_t_Ryy[1][3] = afl_a_Ryy[7];

	afl_t_Ryy[2][0] = afl_a_Ryy[3];
	afl_t_Ryy[2][1] = afl_a_Ryy[4];
	afl_t_Ryy[2][2] = afl_a_Ryy[5];
	afl_t_Ryy[2][3] = afl_a_Ryy[8];

	afl_t_Ryy[3][0] = afl_a_Ryy[6];
	afl_t_Ryy[3][1] = afl_a_Ryy[7];
	afl_t_Ryy[3][2] = afl_a_Ryy[8];
	afl_t_Ryy[3][3] = afl_a_Ryy[9];

	/*********** スペクトラム初期化 *****************/
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		afl_a_spec_bf[s4_t_lp_i] = 0.0;
	}

	/*********** conventional beamformer *****************/
	/**
	 * ウエイトベクトル
	 *  W =  a(θ)
	 * 出力電圧
	 *       1
	 *  P = --- * a(θ)' * R * a(θ)
	 *       2 
	 * 角度スペクトラム（正規化出力電圧）
	 *                   P               a(θ)' * R * a(θ)
	 *  SP(θ) = -------------------- = --------------------
	 *            a'(θ) * a(θ) / 2       a'(θ) * a(θ)
	 */

	/*********** 角度binごとの電力を計算 *****************/
	for (s4_t_lp_i = 0; s4_t_lp_i < N_DOA; s4_t_lp_i++ ) {
		/***********モードベクトル*****************/
		if (s4_a_updn_flg == 1 ) {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] = -CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] = -CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		} else {
			afl_t_mode_vec[0] =  CAFL_D_MODE_VECTOR_0[s4_t_lp_i];
			afl_t_mode_vec[1] =  CAFL_D_MODE_VECTOR_1[s4_t_lp_i];
			afl_t_mode_vec[2] =  CAFL_D_MODE_VECTOR_2[s4_t_lp_i];
			afl_t_mode_vec[3] =  CAFL_D_MODE_VECTOR_3[s4_t_lp_i];
		}

		/* [afl_t_Ryy_mode] = [A] = Kx1 = 4x1 */
		/* fl_t_mode_sum = 0; */
		/* for (s4_t_lp_j=0; s4_t_lp_j<4; s4_t_lp_j++) */
		/* { */
		/* 	fl_t_mode_sum += afl_t_mode_vec[s4_t_lp_j]*afl_t_mode_vec[s4_t_lp_j]; */
		/* }	@@@ fl_t_mode_sum = 4でよい */
		fl_t_Ryy_sum = 0.0F;
		for (s4_t_lp_j = 0; s4_t_lp_j < 4; s4_t_lp_j++ ) {
			afl_t_Ryy_mode[s4_t_lp_j] = 0.0F;
			for (s4_t_lp_k = 0; s4_t_lp_k < 4; s4_t_lp_k++ ) {
				afl_t_Ryy_mode[s4_t_lp_j] += afl_t_Ryy[s4_t_lp_j][s4_t_lp_k] * afl_t_mode_vec[s4_t_lp_k];
			}
			fl_t_Ryy_sum += afl_t_mode_vec[s4_t_lp_j] * afl_t_Ryy_mode[s4_t_lp_j];
		}
		afl_a_spec_bf[s4_t_lp_i] = (0.25F * fl_t_Ryy_sum) / fl_t_mode_sum;		/* $$$ 2013.08.23-6 1/4し忘れバグ */
	}
	return;
}

/**************************************************************************************************/
/* ↑↑↑↑↑↑↑      シミュレーター用コード ECU時はコンパイル対象外             ↑↑↑↑↑↑↑  */
/**************************************************************************************************/
#endif
